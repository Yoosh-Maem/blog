import _extends from "@babel/runtime/helpers/extends";
import _objectSpread from "@babel/runtime/helpers/objectSpread2";
import _slicedToArray from "@babel/runtime/helpers/slicedToArray";
import _objectWithoutProperties from "@babel/runtime/helpers/objectWithoutProperties";
import React, { useEffect, useReducer, useMemo, useRef, useImperativeHandle } from 'react';
import MarkdownPreview from '@uiw/react-markdown-preview';
import TextArea from './components/TextArea';
import Toolbar from './components/Toolbar';
import DragBar from './components/DragBar';
import { getCommands } from './commands';
import { reducer, EditorContext } from './Context';
import "./index.css";

function setGroupPopFalse() {
  var data = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  Object.keys(data).forEach(function (keyname) {
    data[keyname] = false;
  });
  return data;
}

var InternalMDEditor = function InternalMDEditor(props, ref) {
  var _ref = props || {},
      _ref$prefixCls = _ref.prefixCls,
      prefixCls = _ref$prefixCls === void 0 ? 'w-md-editor' : _ref$prefixCls,
      className = _ref.className,
      propsValue = _ref.value,
      _ref$commands = _ref.commands,
      commands = _ref$commands === void 0 ? getCommands() : _ref$commands,
      _ref$height = _ref.height,
      height = _ref$height === void 0 ? 200 : _ref$height,
      _ref$enableScroll = _ref.enableScroll,
      enableScroll = _ref$enableScroll === void 0 ? true : _ref$enableScroll,
      _ref$visiableDragbar = _ref.visiableDragbar,
      visiableDragbar = _ref$visiableDragbar === void 0 ? true : _ref$visiableDragbar,
      _ref$highlightEnable = _ref.highlightEnable,
      highlightEnable = _ref$highlightEnable === void 0 ? true : _ref$highlightEnable,
      _ref$preview = _ref.preview,
      previewType = _ref$preview === void 0 ? 'live' : _ref$preview,
      _ref$fullscreen = _ref.fullscreen,
      fullscreen = _ref$fullscreen === void 0 ? false : _ref$fullscreen,
      _ref$previewOptions = _ref.previewOptions,
      previewOptions = _ref$previewOptions === void 0 ? {} : _ref$previewOptions,
      textareaProps = _ref.textareaProps,
      _ref$maxHeight = _ref.maxHeight,
      maxHeight = _ref$maxHeight === void 0 ? 1200 : _ref$maxHeight,
      _ref$minHeight = _ref.minHeight,
      minHeight = _ref$minHeight === void 0 ? 100 : _ref$minHeight,
      autoFocus = _ref.autoFocus,
      _ref$tabSize = _ref.tabSize,
      tabSize = _ref$tabSize === void 0 ? 2 : _ref$tabSize,
      onChange = _ref.onChange,
      hideToolbar = _ref.hideToolbar,
      other = _objectWithoutProperties(_ref, ["prefixCls", "className", "value", "commands", "height", "enableScroll", "visiableDragbar", "highlightEnable", "preview", "fullscreen", "previewOptions", "textareaProps", "maxHeight", "minHeight", "autoFocus", "tabSize", "onChange", "hideToolbar"]);

  var _useReducer = useReducer(reducer, {
    markdown: propsValue,
    preview: previewType,
    height: height,
    highlightEnable: highlightEnable,
    tabSize: tabSize,
    scrollTop: 0,
    scrollTopPreview: 0,
    commands: commands,
    fullscreen: fullscreen,
    onChange: onChange,
    barPopup: {}
  }),
      _useReducer2 = _slicedToArray(_useReducer, 2),
      state = _useReducer2[0],
      dispatch = _useReducer2[1];

  var container = useRef(null);
  var previewRef = useRef(null);
  var enableScrollRef = useRef(enableScroll);
  useImperativeHandle(ref, function () {
    return _objectSpread({}, state);
  });
  useMemo(function () {
    return enableScrollRef.current = enableScroll;
  }, [enableScroll]);
  useEffect(function () {
    var stateInit = {};

    if (container.current) {
      stateInit.container = container.current || undefined;
    }

    stateInit.markdown = propsValue || '';
    stateInit.barPopup = {};

    if (dispatch) {
      dispatch(_objectSpread(_objectSpread({}, state), stateInit));
    } // eslint-disable-next-line react-hooks/exhaustive-deps

  }, []);
  var cls = [className, prefixCls, state.preview ? "".concat(prefixCls, "-show-").concat(state.preview) : null, state.fullscreen ? "".concat(prefixCls, "-fullscreen") : null].filter(Boolean).join(' ').trim();
  useMemo(function () {
    return propsValue !== state.markdown && dispatch({
      markdown: propsValue
    });
  }, [propsValue]);
  useMemo(function () {
    return previewType !== state.preview && dispatch({
      preview: previewType
    });
  }, [previewType]);
  useMemo(function () {
    return height !== state.height && dispatch({
      height: height
    });
  }, [height]);
  useMemo(function () {
    return tabSize !== state.tabSize && dispatch({
      tabSize: tabSize
    });
  }, [tabSize]);
  useMemo(function () {
    return highlightEnable !== state.highlightEnable && dispatch({
      highlightEnable: highlightEnable
    });
  }, [highlightEnable]);
  useMemo(function () {
    return autoFocus !== state.autoFocus && dispatch({
      autoFocus: autoFocus
    });
  }, [autoFocus]);
  useMemo(function () {
    return fullscreen !== state.fullscreen && dispatch({
      fullscreen: fullscreen
    });
  }, [fullscreen]);
  var textareaDomRef = useRef();
  var active = useRef();
  useMemo(function () {
    textareaDomRef.current = state.textareaWarp;

    if (state.textareaWarp) {
      state.textareaWarp.addEventListener('mouseover', function () {
        active.current = 'text';
      });
      state.textareaWarp.addEventListener('mouseleave', function () {
        active.current = 'preview';
      });
    }
  }, [state.textareaWarp]);

  var handleScroll = function handleScroll(e) {
    if (!enableScrollRef.current) return;
    var textareaDom = textareaDomRef.current;
    var previewDom = previewRef.current ? previewRef.current.mdp.current : undefined;

    if (textareaDom && previewDom) {
      var scale = (textareaDom.scrollHeight - textareaDom.offsetHeight) / (previewDom.scrollHeight - previewDom.offsetHeight);

      if (e.target === textareaDom && active.current === 'text') {
        previewDom.scrollTop = textareaDom.scrollTop / scale;
      }

      if (e.target === previewDom && active.current === 'preview') {
        textareaDom.scrollTop = previewDom.scrollTop * scale;
      }

      var scrollTop = 0;

      if (active.current === 'text') {
        scrollTop = textareaDom.scrollTop || 0;
      } else if (active.current === 'preview') {
        scrollTop = previewDom.scrollTop || 0;
      }

      dispatch({
        scrollTop: scrollTop
      });
    }
  };

  return /*#__PURE__*/React.createElement(EditorContext.Provider, {
    value: _objectSpread(_objectSpread({}, state), {}, {
      dispatch: dispatch
    })
  }, /*#__PURE__*/React.createElement("div", _extends({
    ref: container,
    className: cls,
    onClick: function onClick() {
      dispatch({
        barPopup: _objectSpread({}, setGroupPopFalse(state.barPopup))
      });
    },
    style: {
      height: state.fullscreen ? '100%' : hideToolbar ? Number(state.height) - 29 : state.height
    }
  }, other), !hideToolbar && /*#__PURE__*/React.createElement(Toolbar, {
    prefixCls: prefixCls
  }), /*#__PURE__*/React.createElement("div", {
    className: "".concat(prefixCls, "-content"),
    style: {
      height: state.fullscreen ? 'calc(100% - 29px)' : Number(state.height) - 29
    }
  }, /(edit|live)/.test(state.preview || '') && /*#__PURE__*/React.createElement(TextArea, _extends({
    className: "".concat(prefixCls, "-input"),
    prefixCls: prefixCls,
    autoFocus: autoFocus
  }, textareaProps, {
    onScroll: handleScroll
  })), /(live|preview)/.test(state.preview || '') && /*#__PURE__*/React.createElement(MarkdownPreview, _extends({}, previewOptions, {
    onScroll: handleScroll,
    ref: previewRef,
    source: state.markdown || '',
    className: "".concat(prefixCls, "-preview")
  }))), visiableDragbar && !state.fullscreen && /*#__PURE__*/React.createElement(DragBar, {
    prefixCls: prefixCls,
    height: state.height,
    maxHeight: maxHeight,
    minHeight: minHeight,
    onChange: function onChange(newHeight) {
      dispatch({
        height: newHeight
      });
    }
  })));
};

var mdEditor = /*#__PURE__*/React.forwardRef(InternalMDEditor);
mdEditor.Markdown = MarkdownPreview;
export default mdEditor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9FZGl0b3IudHN4Il0sIm5hbWVzIjpbIlJlYWN0IiwidXNlRWZmZWN0IiwidXNlUmVkdWNlciIsInVzZU1lbW8iLCJ1c2VSZWYiLCJ1c2VJbXBlcmF0aXZlSGFuZGxlIiwiTWFya2Rvd25QcmV2aWV3IiwiVGV4dEFyZWEiLCJUb29sYmFyIiwiRHJhZ0JhciIsImdldENvbW1hbmRzIiwicmVkdWNlciIsIkVkaXRvckNvbnRleHQiLCJzZXRHcm91cFBvcEZhbHNlIiwiZGF0YSIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwia2V5bmFtZSIsIkludGVybmFsTURFZGl0b3IiLCJwcm9wcyIsInJlZiIsInByZWZpeENscyIsImNsYXNzTmFtZSIsInByb3BzVmFsdWUiLCJ2YWx1ZSIsImNvbW1hbmRzIiwiaGVpZ2h0IiwiZW5hYmxlU2Nyb2xsIiwidmlzaWFibGVEcmFnYmFyIiwiaGlnaGxpZ2h0RW5hYmxlIiwicHJldmlldyIsInByZXZpZXdUeXBlIiwiZnVsbHNjcmVlbiIsInByZXZpZXdPcHRpb25zIiwidGV4dGFyZWFQcm9wcyIsIm1heEhlaWdodCIsIm1pbkhlaWdodCIsImF1dG9Gb2N1cyIsInRhYlNpemUiLCJvbkNoYW5nZSIsImhpZGVUb29sYmFyIiwib3RoZXIiLCJtYXJrZG93biIsInNjcm9sbFRvcCIsInNjcm9sbFRvcFByZXZpZXciLCJiYXJQb3B1cCIsInN0YXRlIiwiZGlzcGF0Y2giLCJjb250YWluZXIiLCJwcmV2aWV3UmVmIiwiZW5hYmxlU2Nyb2xsUmVmIiwiY3VycmVudCIsInN0YXRlSW5pdCIsInVuZGVmaW5lZCIsImNscyIsImZpbHRlciIsIkJvb2xlYW4iLCJqb2luIiwidHJpbSIsInRleHRhcmVhRG9tUmVmIiwiYWN0aXZlIiwidGV4dGFyZWFXYXJwIiwiYWRkRXZlbnRMaXN0ZW5lciIsImhhbmRsZVNjcm9sbCIsImUiLCJ0ZXh0YXJlYURvbSIsInByZXZpZXdEb20iLCJtZHAiLCJzY2FsZSIsInNjcm9sbEhlaWdodCIsIm9mZnNldEhlaWdodCIsInRhcmdldCIsIk51bWJlciIsInRlc3QiLCJuZXdIZWlnaHQiLCJtZEVkaXRvciIsImZvcndhcmRSZWYiLCJNYXJrZG93biJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU9BLEtBQVAsSUFBZ0JDLFNBQWhCLEVBQTJCQyxVQUEzQixFQUF1Q0MsT0FBdkMsRUFBZ0RDLE1BQWhELEVBQXdEQyxtQkFBeEQsUUFBbUYsT0FBbkY7QUFDQSxPQUFPQyxlQUFQLE1BQTBFLDZCQUExRTtBQUVBLE9BQU9DLFFBQVAsTUFBeUMsdUJBQXpDO0FBQ0EsT0FBT0MsT0FBUCxNQUFvQixzQkFBcEI7QUFDQSxPQUFPQyxPQUFQLE1BQW9CLHNCQUFwQjtBQUNBLFNBQVNDLFdBQVQsUUFBc0MsWUFBdEM7QUFDQSxTQUFTQyxPQUFULEVBQWtCQyxhQUFsQixRQUFrRSxXQUFsRTtBQUNBOztBQXVFQSxTQUFTQyxnQkFBVCxHQUE4RDtBQUFBLE1BQXBDQyxJQUFvQyx1RUFBSixFQUFJO0FBQzVEQyxFQUFBQSxNQUFNLENBQUNDLElBQVAsQ0FBWUYsSUFBWixFQUFrQkcsT0FBbEIsQ0FBMEIsVUFBQ0MsT0FBRCxFQUFhO0FBQ3JDSixJQUFBQSxJQUFJLENBQUNJLE9BQUQsQ0FBSixHQUFnQixLQUFoQjtBQUNELEdBRkQ7QUFHQSxTQUFPSixJQUFQO0FBQ0Q7O0FBRUQsSUFBTUssZ0JBQWdCLEdBQUcsU0FBbkJBLGdCQUFtQixDQUN2QkMsS0FEdUIsRUFFdkJDLEdBRnVCLEVBR3BCO0FBQUEsYUFxQkNELEtBQUssSUFBSSxFQXJCVjtBQUFBLDRCQUVERSxTQUZDO0FBQUEsTUFFREEsU0FGQywrQkFFVyxhQUZYO0FBQUEsTUFHREMsU0FIQyxRQUdEQSxTQUhDO0FBQUEsTUFJTUMsVUFKTixRQUlEQyxLQUpDO0FBQUEsMkJBS0RDLFFBTEM7QUFBQSxNQUtEQSxRQUxDLDhCQUtVaEIsV0FBVyxFQUxyQjtBQUFBLHlCQU1EaUIsTUFOQztBQUFBLE1BTURBLE1BTkMsNEJBTVEsR0FOUjtBQUFBLCtCQU9E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QUFLLENBQUNoQixPQUFOLElBQWlCLEVBQXZDLGtCQUNDLG9CQUFDLGVBQUQsZUFDT0csY0FEUDtBQUVFLElBQUEsUUFBUSxFQUFFOEIsWUFGWjtBQUdFLElBQUEsR0FBRyxFQUFFZCxVQUhQO0FBSUUsSUFBQSxNQUFNLEVBQUVILEtBQUssQ0FBQ0osUUFBTixJQUFrQixFQUo1QjtBQUtFLElBQUEsU0FBUyxZQUFLckIsU0FBTDtBQUxYLEtBZEosQ0FWRixFQWlDR08sZUFBZSxJQUFJLENBQUNrQixLQUFLLENBQUNkLFVBQTFCLGlCQUNDLG9CQUFDLE9BQUQ7QUFDRSxJQUFBLFNBQVMsRUFBRVgsU0FEYjtBQUVFLElBQUEsTUFBTSxFQUFFeUIsS0FBSyxDQUFDcEIsTUFGaEI7QUFHRSxJQUFBLFNBQVMsRUFBRVMsU0FIYjtBQUlFLElBQUEsU0FBUyxFQUFFQyxTQUpiO0FBS0UsSUFBQSxRQUFRLEVBQUUsa0JBQUNzQyxTQUFELEVBQWU7QUFDdkIzQixNQUFBQSxRQUFRLENBQUM7QUFBRXJCLFFBQUFBLE1BQU0sRUFBRWdEO0FBQVYsT0FBRCxDQUFSO0FBQ0Q7QUFQSCxJQWxDSixDQURGLENBREY7QUFpREQsQ0FsS0Q7O0FBb0tBLElBQU1DLFFBQVEsZ0JBQUc1RSxLQUFLLENBQUM2RSxVQUFOLENBQThDMUQsZ0JBQTlDLENBQWpCO0FBTUN5RCxRQUFELENBQXVCRSxRQUF2QixHQUFrQ3hFLGVBQWxDO0FBRUEsZUFBZXNFLFFBQWYiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgdXNlRWZmZWN0LCB1c2VSZWR1Y2VyLCB1c2VNZW1vLCB1c2VSZWYsIHVzZUltcGVyYXRpdmVIYW5kbGUgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgTWFya2Rvd25QcmV2aWV3LCB7IE1hcmtkb3duUHJldmlld1Byb3BzLCBNYXJrZG93blByZXZpZXdSZWYgfSBmcm9tICdAdWl3L3JlYWN0LW1hcmtkb3duLXByZXZpZXcnO1xuaW1wb3J0IHsgSVByb3BzIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgVGV4dEFyZWEsIHsgSVRleHRBcmVhUHJvcHMgfSBmcm9tICcuL2NvbXBvbmVudHMvVGV4dEFyZWEnO1xuaW1wb3J0IFRvb2xiYXIgZnJvbSAnLi9jb21wb25lbnRzL1Rvb2xiYXInO1xuaW1wb3J0IERyYWdCYXIgZnJvbSAnLi9jb21wb25lbnRzL0RyYWdCYXInO1xuaW1wb3J0IHsgZ2V0Q29tbWFuZHMsIElDb21tYW5kIH0gZnJvbSAnLi9jb21tYW5kcyc7XG5pbXBvcnQgeyByZWR1Y2VyLCBFZGl0b3JDb250ZXh0LCBDb250ZXh0U3RvcmUsIFByZXZpZXdUeXBlIH0gZnJvbSAnLi9Db250ZXh0JztcbmltcG9ydCAnLi9pbmRleC5sZXNzJztcblxuZXhwb3J0IGludGVyZmFjZSBNREVkaXRvclByb3BzIGV4dGVuZHMgT21pdDxSZWFjdC5IVE1MQXR0cmlidXRlczxIVE1MRGl2RWxlbWVudD4sICdvbkNoYW5nZSc+LCBJUHJvcHMge1xuICAvKipcbiAgICogVGhlIE1hcmtkb3duIHZhbHVlLlxuICAgKi9cbiAgdmFsdWU/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBFdmVudCBoYW5kbGVyIGZvciB0aGUgYG9uQ2hhbmdlYCBldmVudC5cbiAgICovXG4gIG9uQ2hhbmdlPzogKHZhbHVlPzogc3RyaW5nKSA9PiB2b2lkO1xuICAvKipcbiAgICogQ2FuIGJlIHVzZWQgdG8gbWFrZSBgTWFya2Rvd24gRWRpdG9yYCBmb2N1cyBpdHNlbGYgb24gaW5pdGlhbGl6YXRpb24uIERlZmF1bHRzIHRvIG9uLlxuICAgKiBpdCB3aWxsIGJlIHNldCB0byB0cnVlIHdoZW4gZWl0aGVyIHRoZSBzb3VyY2UgYHRleHRhcmVhYCBpcyBmb2N1c2VkLFxuICAgKiBvciBpdCBoYXMgYW4gYGF1dG9mb2N1c2AgYXR0cmlidXRlIGFuZCBubyBvdGhlciBlbGVtZW50IGlzIGZvY3VzZWQuXG4gICAqL1xuICBhdXRvRm9jdXM/OiBJVGV4dEFyZWFQcm9wc1snYXV0b0ZvY3VzJ107XG4gIC8qKlxuICAgKiBUaGUgaGVpZ2h0IG9mIHRoZSBlZGl0b3IuXG4gICAqL1xuICBoZWlnaHQ/OiBudW1iZXI7XG4gIC8qKlxuICAgKiBTaG93IGRyYWcgYW5kIGRyb3AgdG9vbC4gU2V0IHRoZSBoZWlnaHQgb2YgdGhlIGVkaXRvci5cbiAgICovXG4gIHZpc2lhYmxlRHJhZ2Jhcj86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBTaG93IG1hcmtkb3duIHByZXZpZXcuXG4gICAqL1xuICBwcmV2aWV3PzogUHJldmlld1R5cGU7XG4gIC8qKlxuICAgKiBGdWxsIHNjcmVlbiBkaXNwbGF5IGVkaXRvci5cbiAgICovXG4gIGZ1bGxzY3JlZW4/OiBib29sZWFuO1xuICAvKipcbiAgICogTWF4aW11bSBkcmFnIGhlaWdodC4gYHZpc2lhYmxlRHJhZ2Jhcj10cnVlYFxuICAgKi9cbiAgbWF4SGVpZ2h0PzogbnVtYmVyO1xuICAvKipcbiAgICogTWluaW11bSBkcmFnIGhlaWdodC4gYHZpc2lhYmxlRHJhZ2Jhcj10cnVlYFxuICAgKi9cbiAgbWluSGVpZ2h0PzogbnVtYmVyO1xuICAvKipcbiAgICogVGhpcyBpcyByZXNldCBbcmVhY3QtbWFya2Rvd25dKGh0dHBzOi8vZ2l0aHViLmNvbS9yZXh4YXJzL3JlYWN0LW1hcmtkb3duKSBzZXR0aW5ncy5cbiAgICovXG4gIHByZXZpZXdPcHRpb25zPzogT21pdDxNYXJrZG93blByZXZpZXdQcm9wcywgJ3NvdXJjZSc+O1xuICAvKipcbiAgICogU2V0IHRoZSBgdGV4dGFyZWFgIHJlbGF0ZWQgcHJvcHMuXG4gICAqL1xuICB0ZXh0YXJlYVByb3BzPzogSVRleHRBcmVhUHJvcHM7XG4gIC8qKlxuICAgKiBEaXNhYmxlIGVkaXRpbmcgYXJlYSBjb2RlIGhpZ2hsaWdodGluZy4gVGhlIHZhbHVlIGlzIGBmYWxzZWAsIHdoaWNoIGluY3JlYXNlcyB0aGUgZWRpdGluZyBzcGVlZC5cbiAgICogQGRlZmF1bHQgdHJ1ZVxuICAgKi9cbiAgaGlnaGxpZ2h0RW5hYmxlPzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFRoZSBudW1iZXIgb2YgY2hhcmFjdGVycyB0byBpbnNlcnQgd2hlbiBwcmVzc2luZyB0YWIga2V5LlxuICAgKiBEZWZhdWx0IGAyYCBzcGFjZXMuXG4gICAqL1xuICB0YWJTaXplPzogbnVtYmVyO1xuICAvKipcbiAgICogWW91IGNhbiBjcmVhdGUgeW91ciBvd24gY29tbWFuZHMgb3IgcmV1c2UgZXhpc3RpbmcgY29tbWFuZHMuXG4gICAqL1xuICBjb21tYW5kcz86IElDb21tYW5kW107XG4gIC8qKlxuICAgKiBIaWRlIHRoZSB0b29sIGJhclxuICAgKi9cbiAgaGlkZVRvb2xiYXI/OiBib29sZWFuO1xuICAvKiogV2hldGhlciB0byBlbmFibGUgc2Nyb2xsaW5nICovXG4gIGVuYWJsZVNjcm9sbD86IGJvb2xlYW47XG59XG5cbmZ1bmN0aW9uIHNldEdyb3VwUG9wRmFsc2UoZGF0YTogUmVjb3JkPHN0cmluZywgYm9vbGVhbj4gPSB7fSkge1xuICBPYmplY3Qua2V5cyhkYXRhKS5mb3JFYWNoKChrZXluYW1lKSA9PiB7XG4gICAgZGF0YVtrZXluYW1lXSA9IGZhbHNlO1xuICB9KTtcbiAgcmV0dXJuIGRhdGE7XG59XG5cbmNvbnN0IEludGVybmFsTURFZGl0b3IgPSAoXG4gIHByb3BzOiBNREVkaXRvclByb3BzLFxuICByZWY/OiAoKGluc3RhbmNlOiBDb250ZXh0U3RvcmUpID0+IHZvaWQpIHwgUmVhY3QuUmVmT2JqZWN0PENvbnRleHRTdG9yZT4gfCBudWxsLFxuKSA9PiB7XG4gIGNvbnN0IHtcbiAgICBwcmVmaXhDbHMgPSAndy1tZC1lZGl0b3InLFxuICAgIGNsYXNzTmFtZSxcbiAgICB2YWx1ZTogcHJvcHNWYWx1ZSxcbiAgICBjb21tYW5kcyA9IGdldENvbW1hbmRzKCksXG4gICAgaGVpZ2h0ID0gMjAwLFxuICAgIGVuYWJsZVNjcm9sbCA9IHRydWUsXG4gICAgdmlzaWFibGVEcmFnYmFyID0gdHJ1ZSxcbiAgICBoaWdobGlnaHRFbmFibGUgPSB0cnVlLFxuICAgIHByZXZpZXc6IHByZXZpZXdUeXBlID0gJ2xpdmUnLFxuICAgIGZ1bGxzY3JlZW4gPSBmYWxzZSxcbiAgICBwcmV2aWV3T3B0aW9ucyA9IHt9LFxuICAgIHRleHRhcmVhUHJvcHMsXG4gICAgbWF4SGVpZ2h0ID0gMTIwMCxcbiAgICBtaW5IZWlnaHQgPSAxMDAsXG4gICAgYXV0b0ZvY3VzLFxuICAgIHRhYlNpemUgPSAyLFxuICAgIG9uQ2hhbmdlLFxuICAgIGhpZGVUb29sYmFyLFxuICAgIC4uLm90aGVyXG4gIH0gPSBwcm9wcyB8fCB7fTtcbiAgbGV0IFtzdGF0ZSwgZGlzcGF0Y2hdID0gdXNlUmVkdWNlcihyZWR1Y2VyLCB7XG4gICAgbWFya2Rvd246IHByb3BzVmFsdWUsXG4gICAgcHJldmlldzogcHJldmlld1R5cGUsXG4gICAgaGVpZ2h0LFxuICAgIGhpZ2hsaWdodEVuYWJsZSxcbiAgICB0YWJTaXplLFxuICAgIHNjcm9sbFRvcDogMCxcbiAgICBzY3JvbGxUb3BQcmV2aWV3OiAwLFxuICAgIGNvbW1hbmRzLFxuICAgIGZ1bGxzY3JlZW4sXG4gICAgb25DaGFuZ2UsXG4gICAgYmFyUG9wdXA6IHt9LFxuICB9KTtcbiAgY29uc3QgY29udGFpbmVyID0gdXNlUmVmPEhUTUxEaXZFbGVtZW50PihudWxsKTtcbiAgY29uc3QgcHJldmlld1JlZiA9IHVzZVJlZjxNYXJrZG93blByZXZpZXdSZWY+KG51bGwpO1xuICBjb25zdCBlbmFibGVTY3JvbGxSZWYgPSB1c2VSZWYoZW5hYmxlU2Nyb2xsKTtcblxuICB1c2VJbXBlcmF0aXZlSGFuZGxlKHJlZiwgKCkgPT4gKHsgLi4uc3RhdGUgfSkpO1xuICB1c2VNZW1vKCgpID0+IChlbmFibGVTY3JvbGxSZWYuY3VycmVudCA9IGVuYWJsZVNjcm9sbCksIFtlbmFibGVTY3JvbGxdKTtcbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBjb25zdCBzdGF0ZUluaXQ6IENvbnRleHRTdG9yZSA9IHt9O1xuICAgIGlmIChjb250YWluZXIuY3VycmVudCkge1xuICAgICAgc3RhdGVJbml0LmNvbnRhaW5lciA9IGNvbnRhaW5lci5jdXJyZW50IHx8IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgc3RhdGVJbml0Lm1hcmtkb3duID0gcHJvcHNWYWx1ZSB8fCAnJztcbiAgICBzdGF0ZUluaXQuYmFyUG9wdXAgPSB7fTtcbiAgICBpZiAoZGlzcGF0Y2gpIHtcbiAgICAgIGRpc3BhdGNoKHsgLi4uc3RhdGUsIC4uLnN0YXRlSW5pdCB9KTtcbiAgICB9XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlYWN0LWhvb2tzL2V4aGF1c3RpdmUtZGVwc1xuICB9LCBbXSk7XG5cbiAgY29uc3QgY2xzID0gW1xuICAgIGNsYXNzTmFtZSxcbiAgICBwcmVmaXhDbHMsXG4gICAgc3RhdGUucHJldmlldyA/IGAke3ByZWZpeENsc30tc2hvdy0ke3N0YXRlLnByZXZpZXd9YCA6IG51bGwsXG4gICAgc3RhdGUuZnVsbHNjcmVlbiA/IGAke3ByZWZpeENsc30tZnVsbHNjcmVlbmAgOiBudWxsLFxuICBdXG4gICAgLmZpbHRlcihCb29sZWFuKVxuICAgIC5qb2luKCcgJylcbiAgICAudHJpbSgpO1xuXG4gIHVzZU1lbW8oKCkgPT4gcHJvcHNWYWx1ZSAhPT0gc3RhdGUubWFya2Rvd24gJiYgZGlzcGF0Y2goeyBtYXJrZG93bjogcHJvcHNWYWx1ZSB9KSwgW3Byb3BzVmFsdWVdKTtcbiAgdXNlTWVtbygoKSA9PiBwcmV2aWV3VHlwZSAhPT0gc3RhdGUucHJldmlldyAmJiBkaXNwYXRjaCh7IHByZXZpZXc6IHByZXZpZXdUeXBlIH0pLCBbcHJldmlld1R5cGVdKTtcbiAgdXNlTWVtbygoKSA9PiBoZWlnaHQgIT09IHN0YXRlLmhlaWdodCAmJiBkaXNwYXRjaCh7IGhlaWdodDogaGVpZ2h0IH0pLCBbaGVpZ2h0XSk7XG4gIHVzZU1lbW8oKCkgPT4gdGFiU2l6ZSAhPT0gc3RhdGUudGFiU2l6ZSAmJiBkaXNwYXRjaCh7IHRhYlNpemUgfSksIFt0YWJTaXplXSk7XG4gIHVzZU1lbW8oKCkgPT4gaGlnaGxpZ2h0RW5hYmxlICE9PSBzdGF0ZS5oaWdobGlnaHRFbmFibGUgJiYgZGlzcGF0Y2goeyBoaWdobGlnaHRFbmFibGUgfSksIFtoaWdobGlnaHRFbmFibGVdKTtcbiAgdXNlTWVtbygoKSA9PiBhdXRvRm9jdXMgIT09IHN0YXRlLmF1dG9Gb2N1cyAmJiBkaXNwYXRjaCh7IGF1dG9Gb2N1czogYXV0b0ZvY3VzIH0pLCBbYXV0b0ZvY3VzXSk7XG4gIHVzZU1lbW8oKCkgPT4gZnVsbHNjcmVlbiAhPT0gc3RhdGUuZnVsbHNjcmVlbiAmJiBkaXNwYXRjaCh7IGZ1bGxzY3JlZW46IGZ1bGxzY3JlZW4gfSksIFtmdWxsc2NyZWVuXSk7XG5cbiAgY29uc3QgdGV4dGFyZWFEb21SZWYgPSB1c2VSZWY8SFRNTERpdkVsZW1lbnQ+KCk7XG4gIGNvbnN0IGFjdGl2ZSA9IHVzZVJlZjwndGV4dCcgfCAncHJldmlldyc+KCk7XG5cbiAgdXNlTWVtbygoKSA9PiB7XG4gICAgdGV4dGFyZWFEb21SZWYuY3VycmVudCA9IHN0YXRlLnRleHRhcmVhV2FycDtcbiAgICBpZiAoc3RhdGUudGV4dGFyZWFXYXJwKSB7XG4gICAgICBzdGF0ZS50ZXh0YXJlYVdhcnAuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VvdmVyJywgKCkgPT4ge1xuICAgICAgICBhY3RpdmUuY3VycmVudCA9ICd0ZXh0JztcbiAgICAgIH0pO1xuICAgICAgc3RhdGUudGV4dGFyZWFXYXJwLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCAoKSA9PiB7XG4gICAgICAgIGFjdGl2ZS5jdXJyZW50ID0gJ3ByZXZpZXcnO1xuICAgICAgfSk7XG4gICAgfVxuICB9LCBbc3RhdGUudGV4dGFyZWFXYXJwXSk7XG5cbiAgY29uc3QgaGFuZGxlU2Nyb2xsID0gKGU6IFJlYWN0LlVJRXZlbnQ8SFRNTERpdkVsZW1lbnQ+KSA9PiB7XG4gICAgaWYgKCFlbmFibGVTY3JvbGxSZWYuY3VycmVudCkgcmV0dXJuO1xuICAgIGNvbnN0IHRleHRhcmVhRG9tID0gdGV4dGFyZWFEb21SZWYuY3VycmVudDtcbiAgICBjb25zdCBwcmV2aWV3RG9tID0gcHJldmlld1JlZi5jdXJyZW50ID8gcHJldmlld1JlZi5jdXJyZW50Lm1kcC5jdXJyZW50IDogdW5kZWZpbmVkO1xuICAgIGlmICh0ZXh0YXJlYURvbSAmJiBwcmV2aWV3RG9tKSB7XG4gICAgICBjb25zdCBzY2FsZSA9XG4gICAgICAgICh0ZXh0YXJlYURvbS5zY3JvbGxIZWlnaHQgLSB0ZXh0YXJlYURvbS5vZmZzZXRIZWlnaHQpIC8gKHByZXZpZXdEb20uc2Nyb2xsSGVpZ2h0IC0gcHJldmlld0RvbS5vZmZzZXRIZWlnaHQpO1xuICAgICAgaWYgKGUudGFyZ2V0ID09PSB0ZXh0YXJlYURvbSAmJiBhY3RpdmUuY3VycmVudCA9PT0gJ3RleHQnKSB7XG4gICAgICAgIHByZXZpZXdEb20uc2Nyb2xsVG9wID0gdGV4dGFyZWFEb20uc2Nyb2xsVG9wIC8gc2NhbGU7XG4gICAgICB9XG4gICAgICBpZiAoZS50YXJnZXQgPT09IHByZXZpZXdEb20gJiYgYWN0aXZlLmN1cnJlbnQgPT09ICdwcmV2aWV3Jykge1xuICAgICAgICB0ZXh0YXJlYURvbS5zY3JvbGxUb3AgPSBwcmV2aWV3RG9tLnNjcm9sbFRvcCAqIHNjYWxlO1xuICAgICAgfVxuICAgICAgbGV0IHNjcm9sbFRvcCA9IDA7XG4gICAgICBpZiAoYWN0aXZlLmN1cnJlbnQgPT09ICd0ZXh0Jykge1xuICAgICAgICBzY3JvbGxUb3AgPSB0ZXh0YXJlYURvbS5zY3JvbGxUb3AgfHwgMDtcbiAgICAgIH0gZWxzZSBpZiAoYWN0aXZlLmN1cnJlbnQgPT09ICdwcmV2aWV3Jykge1xuICAgICAgICBzY3JvbGxUb3AgPSBwcmV2aWV3RG9tLnNjcm9sbFRvcCB8fCAwO1xuICAgICAgfVxuICAgICAgZGlzcGF0Y2goeyBzY3JvbGxUb3AgfSk7XG4gICAgfVxuICB9O1xuXG4gIHJldHVybiAoXG4gICAgPEVkaXRvckNvbnRleHQuUHJvdmlkZXIgdmFsdWU9e3sgLi4uc3RhdGUsIGRpc3BhdGNoIH19PlxuICAgICAgPGRpdlxuICAgICAgICByZWY9e2NvbnRhaW5lcn1cbiAgICAgICAgY2xhc3NOYW1lPXtjbHN9XG4gICAgICAgIG9uQ2xpY2s9eygpID0+IHtcbiAgICAgICAgICBkaXNwYXRjaCh7IGJhclBvcHVwOiB7IC4uLnNldEdyb3VwUG9wRmFsc2Uoc3RhdGUuYmFyUG9wdXApIH0gfSk7XG4gICAgICAgIH19XG4gICAgICAgIHN0eWxlPXt7IGhlaWdodDogc3RhdGUuZnVsbHNjcmVlbiA/ICcxMDAlJyA6IGhpZGVUb29sYmFyID8gTnVtYmVyKHN0YXRlLmhlaWdodCkgLSAyOSA6IHN0YXRlLmhlaWdodCB9fVxuICAgICAgICB7Li4ub3RoZXJ9XG4gICAgICA+XG4gICAgICAgIHshaGlkZVRvb2xiYXIgJiYgPFRvb2xiYXIgcHJlZml4Q2xzPXtwcmVmaXhDbHN9IC8+fVxuICAgICAgICA8ZGl2XG4gICAgICAgICAgY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LWNvbnRlbnRgfVxuICAgICAgICAgIHN0eWxlPXt7IGhlaWdodDogc3RhdGUuZnVsbHNjcmVlbiA/ICdjYWxjKDEwMCUgLSAyOXB4KScgOiBOdW1iZXIoc3RhdGUuaGVpZ2h0KSAtIDI5IH19XG4gICAgICAgID5cbiAgICAgICAgICB7LyhlZGl0fGxpdmUpLy50ZXN0KHN0YXRlLnByZXZpZXcgfHwgJycpICYmIChcbiAgICAgICAgICAgIDxUZXh0QXJlYVxuICAgICAgICAgICAgICBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30taW5wdXRgfVxuICAgICAgICAgICAgICBwcmVmaXhDbHM9e3ByZWZpeENsc31cbiAgICAgICAgICAgICAgYXV0b0ZvY3VzPXthdXRvRm9jdXN9XG4gICAgICAgICAgICAgIHsuLi50ZXh0YXJlYVByb3BzfVxuICAgICAgICAgICAgICBvblNjcm9sbD17aGFuZGxlU2Nyb2xsfVxuICAgICAgICAgICAgLz5cbiAgICAgICAgICApfVxuICAgICAgICAgIHsvKGxpdmV8cHJldmlldykvLnRlc3Qoc3RhdGUucHJldmlldyB8fCAnJykgJiYgKFxuICAgICAgICAgICAgPE1hcmtkb3duUHJldmlld1xuICAgICAgICAgICAgICB7Li4uKHByZXZpZXdPcHRpb25zIGFzIHVua25vd24pfVxuICAgICAgICAgICAgICBvblNjcm9sbD17aGFuZGxlU2Nyb2xsfVxuICAgICAgICAgICAgICByZWY9e3ByZXZpZXdSZWZ9XG4gICAgICAgICAgICAgIHNvdXJjZT17c3RhdGUubWFya2Rvd24gfHwgJyd9XG4gICAgICAgICAgICAgIGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS1wcmV2aWV3YH1cbiAgICAgICAgICAgIC8+XG4gICAgICAgICAgKX1cbiAgICAgICAgPC9kaXY+XG4gICAgICAgIHt2aXNpYWJsZURyYWdiYXIgJiYgIXN0YXRlLmZ1bGxzY3JlZW4gJiYgKFxuICAgICAgICAgIDxEcmFnQmFyXG4gICAgICAgICAgICBwcmVmaXhDbHM9e3ByZWZpeENsc31cbiAgICAgICAgICAgIGhlaWdodD17c3RhdGUuaGVpZ2h0IGFzIG51bWJlcn1cbiAgICAgICAgICAgIG1heEhlaWdodD17bWF4SGVpZ2h0IX1cbiAgICAgICAgICAgIG1pbkhlaWdodD17bWluSGVpZ2h0IX1cbiAgICAgICAgICAgIG9uQ2hhbmdlPXsobmV3SGVpZ2h0KSA9PiB7XG4gICAgICAgICAgICAgIGRpc3BhdGNoKHsgaGVpZ2h0OiBuZXdIZWlnaHQgfSk7XG4gICAgICAgICAgICB9fVxuICAgICAgICAgIC8+XG4gICAgICAgICl9XG4gICAgICA8L2Rpdj5cbiAgICA8L0VkaXRvckNvbnRleHQuUHJvdmlkZXI+XG4gICk7XG59O1xuXG5jb25zdCBtZEVkaXRvciA9IFJlYWN0LmZvcndhcmRSZWY8Q29udGV4dFN0b3JlLCBNREVkaXRvclByb3BzPihJbnRlcm5hbE1ERWRpdG9yKTtcblxudHlwZSBNREVkaXRvciA9IHR5cGVvZiBtZEVkaXRvciAmIHtcbiAgTWFya2Rvd246IHR5cGVvZiBNYXJrZG93blByZXZpZXc7XG59O1xuXG4obWRFZGl0b3IgYXMgTURFZGl0b3IpLk1hcmtkb3duID0gTWFya2Rvd25QcmV2aWV3O1xuXG5leHBvcnQgZGVmYXVsdCBtZEVkaXRvciBhcyBNREVkaXRvcjtcbiJdfQ==