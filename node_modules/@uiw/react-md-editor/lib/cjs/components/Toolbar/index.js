"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard").default;

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault").default;

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Toolbar;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _react = _interopRequireWildcard(require("react"));

var _Context = require("../../Context");

var _Child = _interopRequireDefault(require("./Child"));

function Toolbar() {
  var props = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var prefixCls = props.prefixCls;

  var _useContext = (0, _react.useContext)(_Context.EditorContext),
      commands = _useContext.commands,
      fullscreen = _useContext.fullscreen,
      preview = _useContext.preview,
      _useContext$barPopup = _useContext.barPopup,
      barPopup = _useContext$barPopup === void 0 ? {} : _useContext$barPopup,
      commandOrchestrator = _useContext.commandOrchestrator,
      dispatch = _useContext.dispatch;

  function handleClick(command, name) {
    if (!dispatch) return;
    var state = {
      barPopup: (0, _objectSpread2.default)({}, barPopup)
    };

    if (command.keyCommand === 'preview') {
      state.preview = command.value;
    }

    if (command.keyCommand === 'fullscreen') {
      state.fullscreen = !fullscreen;
      document.body.style.overflow = fullscreen ? 'initial' : 'hidden';
    }

    if (commands && command.keyCommand === 'group') {
      commands.forEach(function (item) {
        if (name === item.groupName) {
          state.barPopup[name] = true;
        } else if (item.keyCommand) {
          state.barPopup[item.groupName] = false;
        }
      });
    } else if (name || command.parent) {
      Object.keys(state.barPopup || {}).forEach(function (keyName) {
        state.barPopup[keyName] = false;
      });
    }

    if (Object.keys(state).length) {
      dispatch((0, _objectSpread2.default)({}, state));
    }

    commandOrchestrator && commandOrchestrator.executeCommand(command);
  }

  return /*#__PURE__*/_react.default.createElement("div", {
    className: "".concat(prefixCls, "-toolbar")
  }, /*#__PURE__*/_react.default.createElement("ul", null, (props.commands || commands || []).map(function (item, idx) {
    if (item.keyCommand === 'divider') {
      return /*#__PURE__*/_react.default.createElement("li", (0, _extends2.default)({
        key: idx
      }, item.liProps, {
        className: "".concat(prefixCls, "-toolbar-divider")
      }));
    }

    if (!item.keyCommand) return /*#__PURE__*/_react.default.createElement(_react.Fragment, null);
    var activeBtn = fullscreen && item.keyCommand === 'fullscreen' || item.keyCommand === 'preview' && preview === item.value;
    var childNode = typeof item.children === 'function' ? item.children({
      getState: function getState() {
        return commandOrchestrator.getState();
      },
      textApi: commandOrchestrator ? commandOrchestrator.textApi : undefined,
      close: function close() {
        return handleClick({}, item.groupName);
      },
      execute: function execute() {
        return handleClick({
          execute: item.execute
        });
      }
    }) : undefined;
    var disabled = barPopup && preview && preview === 'preview' && !/(preview|fullscreen)/.test(item.keyCommand);
    return /*#__PURE__*/_react.default.createElement("li", (0, _extends2.default)({
      key: idx
    }, item.liProps, {
      className: activeBtn ? "active" : ''
    }), !item.buttonProps && item.icon, item.buttonProps && /*#__PURE__*/_react.default.createElement('button', (0, _objectSpread2.default)((0, _objectSpread2.default)({
      type: 'button',
      disabled: disabled,
      'data-name': item.name
    }, item.buttonProps), {}, {
      onClick: function onClick(evn) {
        evn.stopPropagation();
        handleClick(item, item.groupName);
      }
    }), item.icon), item.children && /*#__PURE__*/_react.default.createElement(_Child.default, {
      groupName: item.groupName,
      prefixCls: prefixCls,
      children: childNode,
      commands: Array.isArray(item.children) && typeof item.children !== 'function' ? item.children : undefined
    }));
  })));
}

module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL1Rvb2xiYXIvaW5kZXgudHN4Il0sIm5hbWVzIjpbIlRvb2xiYXIiLCJwcm9wcyIsInByZWZpeENscyIsIkVkaXRvckNvbnRleHQiLCJjb21tYW5kcyIsImZ1bGxzY3JlZW4iLCJwcmV2aWV3IiwiYmFyUG9wdXAiLCJjb21tYW5kT3JjaGVzdHJhdG9yIiwiZGlzcGF0Y2giLCJoYW5kbGVDbGljayIsImNvbW1hbmQiLCJuYW1lIiwic3RhdGUiLCJrZXlDb21tYW5kIiwidmFsdWUiLCJkb2N1bWVudCIsImJvZHkiLCJzdHlsZSIsIm92ZXJmbG93IiwiZm9yRWFjaCIsIml0ZW0iLCJncm91cE5hbWUiLCJwYXJlbnQiLCJPYmplY3QiLCJrZXlzIiwia2V5TmFtZSIsImxlbmd0aCIsImV4ZWN1dGVDb21tYW5kIiwibWFwIiwiaWR4IiwibGlQcm9wcyIsImFjdGl2ZUJ0biIsImNoaWxkTm9kZSIsImNoaWxkcmVuIiwiZ2V0U3RhdGUiLCJ0ZXh0QXBpIiwidW5kZWZpbmVkIiwiY2xvc2UiLCJleGVjdXRlIiwiZGlzYWJsZWQiLCJ0ZXN0IiwiYnV0dG9uUHJvcHMiLCJpY29uIiwiUmVhY3QiLCJjcmVhdGVFbGVtZW50IiwidHlwZSIsIm9uQ2xpY2siLCJldm4iLCJzdG9wUHJvcGFnYXRpb24iLCJBcnJheSIsImlzQXJyYXkiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUVBOztBQUVBOztBQVFlLFNBQVNBLE9BQVQsR0FBNEM7QUFBQSxNQUEzQkMsS0FBMkIsdUVBQUosRUFBSTtBQUFBLE1BQ2pEQyxTQURpRCxHQUNuQ0QsS0FEbUMsQ0FDakRDLFNBRGlEOztBQUFBLG9CQUUrQix1QkFBV0Msc0JBQVgsQ0FGL0I7QUFBQSxNQUVqREMsUUFGaUQsZUFFakRBLFFBRmlEO0FBQUEsTUFFdkNDLFVBRnVDLGVBRXZDQSxVQUZ1QztBQUFBLE1BRTNCQyxPQUYyQixlQUUzQkEsT0FGMkI7QUFBQSx5Q0FFbEJD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QUFXLENBQUNXLElBQUQsRUFBT0EsSUFBSSxDQUFDQyxTQUFaLENBQVg7QUFDRDtBQVZMLFFBWUVELElBQUksQ0FBQ3NCLElBWlAsQ0FISixFQWlCR3RCLElBQUksQ0FBQ2EsUUFBTCxpQkFDQyw2QkFBQyxjQUFEO0FBQ0UsTUFBQSxTQUFTLEVBQUViLElBQUksQ0FBQ0MsU0FEbEI7QUFFRSxNQUFBLFNBQVMsRUFBRXBCLFNBRmI7QUFHRSxNQUFBLFFBQVEsRUFBRStCLFNBSFo7QUFJRSxNQUFBLFFBQVEsRUFDTmlCLEtBQUssQ0FBQ0MsT0FBTixDQUFjOUIsSUFBSSxDQUFDYSxRQUFuQixLQUFnQyxPQUFPYixJQUFJLENBQUNhLFFBQVosS0FBeUIsVUFBekQsR0FBc0ViLElBQUksQ0FBQ2EsUUFBM0UsR0FBc0ZHO0FBTDFGLE1BbEJKLENBREY7QUE4QkQsR0FqREEsQ0FESCxDQURGLENBREY7QUF3REQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgRnJhZ21lbnQsIHVzZUNvbnRleHQgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBJUHJvcHMgfSBmcm9tICcuLi8uLi91dGlscyc7XG5pbXBvcnQgeyBFZGl0b3JDb250ZXh0LCBQcmV2aWV3VHlwZSwgQ29udGV4dFN0b3JlIH0gZnJvbSAnLi4vLi4vQ29udGV4dCc7XG5pbXBvcnQgeyBJQ29tbWFuZCB9IGZyb20gJy4uLy4uL2NvbW1hbmRzJztcbmltcG9ydCBDaGlsZCBmcm9tICcuL0NoaWxkJztcbmltcG9ydCAnLi9pbmRleC5sZXNzJztcblxuZXhwb3J0IGludGVyZmFjZSBJVG9vbGJhclByb3BzIGV4dGVuZHMgSVByb3BzIHtcbiAgb25Db21tYW5kPzogKGNvbW1hbmQ6IElDb21tYW5kPHN0cmluZz4sIGdyb3VwTmFtZT86IHN0cmluZykgPT4gdm9pZDtcbiAgY29tbWFuZHM/OiBJQ29tbWFuZDxzdHJpbmc+W107XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIFRvb2xiYXIocHJvcHM6IElUb29sYmFyUHJvcHMgPSB7fSkge1xuICBjb25zdCB7IHByZWZpeENscyB9ID0gcHJvcHM7XG4gIGNvbnN0IHsgY29tbWFuZHMsIGZ1bGxzY3JlZW4sIHByZXZpZXcsIGJhclBvcHVwID0ge30sIGNvbW1hbmRPcmNoZXN0cmF0b3IsIGRpc3BhdGNoIH0gPSB1c2VDb250ZXh0KEVkaXRvckNvbnRleHQpO1xuICBmdW5jdGlvbiBoYW5kbGVDbGljayhjb21tYW5kOiBJQ29tbWFuZDxzdHJpbmc+LCBuYW1lPzogc3RyaW5nKSB7XG4gICAgaWYgKCFkaXNwYXRjaCkgcmV0dXJuO1xuICAgIGNvbnN0IHN0YXRlOiBDb250ZXh0U3RvcmUgPSB7IGJhclBvcHVwOiB7IC4uLmJhclBvcHVwIH0gfTtcbiAgICBpZiAoY29tbWFuZC5rZXlDb21tYW5kID09PSAncHJldmlldycpIHtcbiAgICAgIHN0YXRlLnByZXZpZXcgPSBjb21tYW5kLnZhbHVlIGFzIFByZXZpZXdUeXBlO1xuICAgIH1cbiAgICBpZiAoY29tbWFuZC5rZXlDb21tYW5kID09PSAnZnVsbHNjcmVlbicpIHtcbiAgICAgIHN0YXRlLmZ1bGxzY3JlZW4gPSAhZnVsbHNjcmVlbjtcbiAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUub3ZlcmZsb3cgPSBmdWxsc2NyZWVuID8gJ2luaXRpYWwnIDogJ2hpZGRlbic7XG4gICAgfVxuICAgIGlmIChjb21tYW5kcyAmJiBjb21tYW5kLmtleUNvbW1hbmQgPT09ICdncm91cCcpIHtcbiAgICAgIGNvbW1hbmRzLmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICAgICAgaWYgKG5hbWUgPT09IGl0ZW0uZ3JvdXBOYW1lKSB7XG4gICAgICAgICAgc3RhdGUuYmFyUG9wdXAhW25hbWUhXSA9IHRydWU7XG4gICAgICAgIH0gZWxzZSBpZiAoaXRlbS5rZXlDb21tYW5kKSB7XG4gICAgICAgICAgc3RhdGUuYmFyUG9wdXAhW2l0ZW0uZ3JvdXBOYW1lIV0gPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChuYW1lIHx8IGNvbW1hbmQucGFyZW50KSB7XG4gICAgICBPYmplY3Qua2V5cyhzdGF0ZS5iYXJQb3B1cCB8fCB7fSkuZm9yRWFjaCgoa2V5TmFtZSkgPT4ge1xuICAgICAgICBzdGF0ZS5iYXJQb3B1cCFba2V5TmFtZV0gPSBmYWxzZTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChPYmplY3Qua2V5cyhzdGF0ZSkubGVuZ3RoKSB7XG4gICAgICBkaXNwYXRjaCh7IC4uLnN0YXRlIH0pO1xuICAgIH1cbiAgICBjb21tYW5kT3JjaGVzdHJhdG9yICYmIGNvbW1hbmRPcmNoZXN0cmF0b3IuZXhlY3V0ZUNvbW1hbmQoY29tbWFuZCk7XG4gIH1cbiAgcmV0dXJuIChcbiAgICA8ZGl2IGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS10b29sYmFyYH0+XG4gICAgICA8dWw+XG4gICAgICAgIHsocHJvcHMuY29tbWFuZHMgfHwgY29tbWFuZHMgfHwgW10pLm1hcCgoaXRlbSwgaWR4KSA9PiB7XG4gICAgICAgICAgaWYgKGl0ZW0ua2V5Q29tbWFuZCA9PT0gJ2RpdmlkZXInKSB7XG4gICAgICAgICAgICByZXR1cm4gPGxpIGtleT17aWR4fSB7Li4uaXRlbS5saVByb3BzfSBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tdG9vbGJhci1kaXZpZGVyYH0gLz47XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghaXRlbS5rZXlDb21tYW5kKSByZXR1cm4gPEZyYWdtZW50IC8+O1xuICAgICAgICAgIGNvbnN0IGFjdGl2ZUJ0biA9XG4gICAgICAgICAgICAoZnVsbHNjcmVlbiAmJiBpdGVtLmtleUNvbW1hbmQgPT09ICdmdWxsc2NyZWVuJykgfHxcbiAgICAgICAgICAgIChpdGVtLmtleUNvbW1hbmQgPT09ICdwcmV2aWV3JyAmJiBwcmV2aWV3ID09PSBpdGVtLnZhbHVlKTtcbiAgICAgICAgICBjb25zdCBjaGlsZE5vZGUgPVxuICAgICAgICAgICAgdHlwZW9mIGl0ZW0uY2hpbGRyZW4gPT09ICdmdW5jdGlvbidcbiAgICAgICAgICAgICAgPyBpdGVtLmNoaWxkcmVuKHtcbiAgICAgICAgICAgICAgICAgIGdldFN0YXRlOiAoKSA9PiBjb21tYW5kT3JjaGVzdHJhdG9yIS5nZXRTdGF0ZSgpLFxuICAgICAgICAgICAgICAgICAgdGV4dEFwaTogY29tbWFuZE9yY2hlc3RyYXRvciA/IGNvbW1hbmRPcmNoZXN0cmF0b3IhLnRleHRBcGkgOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgICBjbG9zZTogKCkgPT4gaGFuZGxlQ2xpY2soe30sIGl0ZW0uZ3JvdXBOYW1lKSxcbiAgICAgICAgICAgICAgICAgIGV4ZWN1dGU6ICgpID0+IGhhbmRsZUNsaWNrKHsgZXhlY3V0ZTogaXRlbS5leGVjdXRlIH0pLFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIDogdW5kZWZpbmVkO1xuICAgICAgICAgIGNvbnN0IGRpc2FibGVkID1cbiAgICAgICAgICAgIGJhclBvcHVwICYmIHByZXZpZXcgJiYgcHJldmlldyA9PT0gJ3ByZXZpZXcnICYmICEvKHByZXZpZXd8ZnVsbHNjcmVlbikvLnRlc3QoaXRlbS5rZXlDb21tYW5kKTtcbiAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGxpIGtleT17aWR4fSB7Li4uaXRlbS5saVByb3BzfSBjbGFzc05hbWU9e2FjdGl2ZUJ0biA/IGBhY3RpdmVgIDogJyd9PlxuICAgICAgICAgICAgICB7IWl0ZW0uYnV0dG9uUHJvcHMgJiYgaXRlbS5pY29ufVxuICAgICAgICAgICAgICB7aXRlbS5idXR0b25Qcm9wcyAmJlxuICAgICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoXG4gICAgICAgICAgICAgICAgICAnYnV0dG9uJyxcbiAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2J1dHRvbicsXG4gICAgICAgICAgICAgICAgICAgIGRpc2FibGVkLFxuICAgICAgICAgICAgICAgICAgICAnZGF0YS1uYW1lJzogaXRlbS5uYW1lLFxuICAgICAgICAgICAgICAgICAgICAuLi5pdGVtLmJ1dHRvblByb3BzLFxuICAgICAgICAgICAgICAgICAgICBvbkNsaWNrOiAoZXZuOiBSZWFjdC5Nb3VzZUV2ZW50PEhUTUxCdXR0b25FbGVtZW50LCBNb3VzZUV2ZW50PikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgIGV2bi5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVDbGljayhpdGVtLCBpdGVtLmdyb3VwTmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgaXRlbS5pY29uLFxuICAgICAgICAgICAgICAgICl9XG4gICAgICAgICAgICAgIHtpdGVtLmNoaWxkcmVuICYmIChcbiAgICAgICAgICAgICAgICA8Q2hpbGRcbiAgICAgICAgICAgICAgICAgIGdyb3VwTmFtZT17aXRlbS5ncm91cE5hbWV9XG4gICAgICAgICAgICAgICAgICBwcmVmaXhDbHM9e3ByZWZpeENsc31cbiAgICAgICAgICAgICAgICAgIGNoaWxkcmVuPXtjaGlsZE5vZGV9XG4gICAgICAgICAgICAgICAgICBjb21tYW5kcz17XG4gICAgICAgICAgICAgICAgICAgIEFycmF5LmlzQXJyYXkoaXRlbS5jaGlsZHJlbikgJiYgdHlwZW9mIGl0ZW0uY2hpbGRyZW4gIT09ICdmdW5jdGlvbicgPyBpdGVtLmNoaWxkcmVuIDogdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgKX1cbiAgICAgICAgICAgIDwvbGk+XG4gICAgICAgICAgKTtcbiAgICAgICAgfSl9XG4gICAgICA8L3VsPlxuICAgIDwvZGl2PlxuICApO1xufVxuIl19