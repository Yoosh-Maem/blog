"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard").default;

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault").default;

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _react = _interopRequireWildcard(require("react"));

var _reactMarkdownPreview = _interopRequireDefault(require("@uiw/react-markdown-preview"));

var _TextArea = _interopRequireDefault(require("./components/TextArea"));

var _Toolbar = _interopRequireDefault(require("./components/Toolbar"));

var _DragBar = _interopRequireDefault(require("./components/DragBar"));

var _commands = require("./commands");

var _Context = require("./Context");

function setGroupPopFalse() {
  var data = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  Object.keys(data).forEach(function (keyname) {
    data[keyname] = false;
  });
  return data;
}

var InternalMDEditor = function InternalMDEditor(props, ref) {
  var _ref = props || {},
      _ref$prefixCls = _ref.prefixCls,
      prefixCls = _ref$prefixCls === void 0 ? 'w-md-editor' : _ref$prefixCls,
      className = _ref.className,
      propsValue = _ref.value,
      _ref$commands = _ref.commands,
      commands = _ref$commands === void 0 ? (0, _commands.getCommands)() : _ref$commands,
      _ref$height = _ref.height,
      height = _ref$height === void 0 ? 200 : _ref$height,
      _ref$enableScroll = _ref.enableScroll,
      enableScroll = _ref$enableScroll === void 0 ? true : _ref$enableScroll,
      _ref$visiableDragbar = _ref.visiableDragbar,
      visiableDragbar = _ref$visiableDragbar === void 0 ? true : _ref$visiableDragbar,
      _ref$highlightEnable = _ref.highlightEnable,
      highlightEnable = _ref$highlightEnable === void 0 ? true : _ref$highlightEnable,
      _ref$preview = _ref.preview,
      previewType = _ref$preview === void 0 ? 'live' : _ref$preview,
      _ref$fullscreen = _ref.fullscreen,
      fullscreen = _ref$fullscreen === void 0 ? false : _ref$fullscreen,
      _ref$previewOptions = _ref.previewOptions,
      previewOptions = _ref$previewOptions === void 0 ? {} : _ref$previewOptions,
      textareaProps = _ref.textareaProps,
      _ref$maxHeight = _ref.maxHeight,
      maxHeight = _ref$maxHeight === void 0 ? 1200 : _ref$maxHeight,
      _ref$minHeight = _ref.minHeight,
      minHeight = _ref$minHeight === void 0 ? 100 : _ref$minHeight,
      autoFocus = _ref.autoFocus,
      _ref$tabSize = _ref.tabSize,
      tabSize = _ref$tabSize === void 0 ? 2 : _ref$tabSize,
      onChange = _ref.onChange,
      hideToolbar = _ref.hideToolbar,
      other = (0, _objectWithoutProperties2.default)(_ref, ["prefixCls", "className", "value", "commands", "height", "enableScroll", "visiableDragbar", "highlightEnable", "preview", "fullscreen", "previewOptions", "textareaProps", "maxHeight", "minHeight", "autoFocus", "tabSize", "onChange", "hideToolbar"]);

  var _useReducer = (0, _react.useReducer)(_Context.reducer, {
    markdown: propsValue,
    preview: previewType,
    height: height,
    highlightEnable: highlightEnable,
    tabSize: tabSize,
    scrollTop: 0,
    scrollTopPreview: 0,
    commands: commands,
    fullscreen: fullscreen,
    onChange: onChange,
    barPopup: {}
  }),
      _useReducer2 = (0, _slicedToArray2.default)(_useReducer, 2),
      state = _useReducer2[0],
      dispatch = _useReducer2[1];

  var container = (0, _react.useRef)(null);
  var previewRef = (0, _react.useRef)(null);
  var enableScrollRef = (0, _react.useRef)(enableScroll);
  (0, _react.useImperativeHandle)(ref, function () {
    return (0, _objectSpread2.default)({}, state);
  });
  (0, _react.useMemo)(function () {
    return enableScrollRef.current = enableScroll;
  }, [enableScroll]);
  (0, _react.useEffect)(function () {
    var stateInit = {};

    if (container.current) {
      stateInit.container = container.current || undefined;
    }

    stateInit.markdown = propsValue || '';
    stateInit.barPopup = {};

    if (dispatch) {
      dispatch((0, _objectSpread2.default)((0, _objectSpread2.default)({}, state), stateInit));
    } // eslint-disable-next-line react-hooks/exhaustive-deps

  }, []);
  var cls = [className, prefixCls, state.preview ? "".concat(prefixCls, "-show-").concat(state.preview) : null, state.fullscreen ? "".concat(prefixCls, "-fullscreen") : null].filter(Boolean).join(' ').trim();
  (0, _react.useMemo)(function () {
    return propsValue !== state.markdown && dispatch({
      markdown: propsValue
    });
  }, [propsValue]);
  (0, _react.useMemo)(function () {
    return previewType !== state.preview && dispatch({
      preview: previewType
    });
  }, [previewType]);
  (0, _react.useMemo)(function () {
    return height !== state.height && dispatch({
      height: height
    });
  }, [height]);
  (0, _react.useMemo)(function () {
    return tabSize !== state.tabSize && dispatch({
      tabSize: tabSize
    });
  }, [tabSize]);
  (0, _react.useMemo)(function () {
    return highlightEnable !== state.highlightEnable && dispatch({
      highlightEnable: highlightEnable
    });
  }, [highlightEnable]);
  (0, _react.useMemo)(function () {
    return autoFocus !== state.autoFocus && dispatch({
      autoFocus: autoFocus
    });
  }, [autoFocus]);
  (0, _react.useMemo)(function () {
    return fullscreen !== state.fullscreen && dispatch({
      fullscreen: fullscreen
    });
  }, [fullscreen]);
  var textareaDomRef = (0, _react.useRef)();
  var active = (0, _react.useRef)();
  (0, _react.useMemo)(function () {
    textareaDomRef.current = state.textareaWarp;

    if (state.textareaWarp) {
      state.textareaWarp.addEventListener('mouseover', function () {
        active.current = 'text';
      });
      state.textareaWarp.addEventListener('mouseleave', function () {
        active.current = 'preview';
      });
    }
  }, [state.textareaWarp]);

  var handleScroll = function handleScroll(e) {
    if (!enableScrollRef.current) return;
    var textareaDom = textareaDomRef.current;
    var previewDom = previewRef.current ? previewRef.current.mdp.current : undefined;

    if (textareaDom && previewDom) {
      var scale = (textareaDom.scrollHeight - textareaDom.offsetHeight) / (previewDom.scrollHeight - previewDom.offsetHeight);

      if (e.target === textareaDom && active.current === 'text') {
        previewDom.scrollTop = textareaDom.scrollTop / scale;
      }

      if (e.target === previewDom && active.current === 'preview') {
        textareaDom.scrollTop = previewDom.scrollTop * scale;
      }

      var scrollTop = 0;

      if (active.current === 'text') {
        scrollTop = textareaDom.scrollTop || 0;
      } else if (active.current === 'preview') {
        scrollTop = previewDom.scrollTop || 0;
      }

      dispatch({
        scrollTop: scrollTop
      });
    }
  };

  return /*#__PURE__*/_react.default.createElement(_Context.EditorContext.Provider, {
    value: (0, _objectSpread2.default)((0, _objectSpread2.default)({}, state), {}, {
      dispatch: dispatch
    })
  }, /*#__PURE__*/_react.default.createElement("div", (0, _extends2.default)({
    ref: container,
    className: cls,
    onClick: function onClick() {
      dispatch({
        barPopup: (0, _objectSpread2.default)({}, setGroupPopFalse(state.barPopup))
      });
    },
    style: {
      height: state.fullscreen ? '100%' : hideToolbar ? Number(state.height) - 29 : state.height
    }
  }, other), !hideToolbar && /*#__PURE__*/_react.default.createElement(_Toolbar.default, {
    prefixCls: prefixCls
  }), /*#__PURE__*/_react.default.createElement("div", {
    className: "".concat(prefixCls, "-content"),
    style: {
      height: state.fullscreen ? 'calc(100% - 29px)' : Number(state.height) - 29
    }
  }, /(edit|live)/.test(state.preview || '') && /*#__PURE__*/_react.default.createElement(_TextArea.default, (0, _extends2.default)({
    className: "".concat(prefixCls, "-input"),
    prefixCls: prefixCls,
    autoFocus: autoFocus
  }, textareaProps, {
    onScroll: handleScroll
  })), /(live|preview)/.test(state.preview || '') && /*#__PURE__*/_react.default.createElement(_reactMarkdownPreview.default, (0, _extends2.default)({}, previewOptions, {
    onScroll: handleScroll,
    ref: previewRef,
    source: state.markdown || '',
    className: "".concat(prefixCls, "-preview")
  }))), visiableDragbar && !state.fullscreen && /*#__PURE__*/_react.default.createElement(_DragBar.default, {
    prefixCls: prefixCls,
    height: state.height,
    maxHeight: maxHeight,
    minHeight: minHeight,
    onChange: function onChange(newHeight) {
      dispatch({
        height: newHeight
      });
    }
  })));
};

var mdEditor = /*#__PURE__*/_react.default.forwardRef(InternalMDEditor);

mdEditor.Markdown = _reactMarkdownPreview.default;
var _default = mdEditor;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9FZGl0b3IudHN4Il0sIm5hbWVzIjpbInNldEdyb3VwUG9wRmFsc2UiLCJkYXRhIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJrZXluYW1lIiwiSW50ZXJuYWxNREVkaXRvciIsInByb3BzIiwicmVmIiwicHJlZml4Q2xzIiwiY2xhc3NOYW1lIiwicHJvcHNWYWx1ZSIsInZhbHVlIiwiY29tbWFuZHMiLCJoZWlnaHQiLCJlbmFibGVTY3JvbGwiLCJ2aXNpYWJsZURyYWdiYXIiLCJoaWdobGlnaHRFbmFibGUiLCJwcmV2aWV3IiwicHJldmlld1R5cGUiLCJmdWxsc2NyZWVuIiwicHJldmlld09wdGlvbnMiLCJ0ZXh0YXJlYVByb3BzIiwibWF4SGVpZ2h0IiwibWluSGVpZ2h0IiwiYXV0b0ZvY3VzIiwidGFiU2l6ZSIsIm9uQ2hhbmdlIiwiaGlkZVRvb2xiYXIiLCJvdGhlciIsInJlZHVjZXIiLCJtYXJrZG93biIsInNjcm9sbFRvcCIsInNjcm9sbFRvcFByZXZpZXciLCJiYXJQb3B1cCIsInN0YXRlIiwiZGlzcGF0Y2giLCJjb250YWluZXIiLCJwcmV2aWV3UmVmIiwiZW5hYmxlU2Nyb2xsUmVmIiwiY3VycmVudCIsInN0YXRlSW5pdCIsInVuZGVmaW5lZCIsImNscyIsImZpbHRlciIsIkJvb2xlYW4iLCJqb2luIiwidHJpbSIsInRleHRhcmVhRG9tUmVmIiwiYWN0aXZlIiwidGV4dGFyZWFXYXJwIiwiYWRkRXZlbnRMaXN0ZW5lciIsImhhbmRsZVNjcm9sbCIsImUiLCJ0ZXh0YXJlYURvbSIsInByZXZpZXdEb20iLCJtZHAiLCJzY2FsZSIsInNjcm9sbEhlaWdodCIsIm9mZnNldEhlaWdodCIsInRhcmdldCIsIk51bWJlciIsInRlc3QiLCJuZXdIZWlnaHQiLCJtZEVkaXRvciIsIlJlYWN0IiwiZm9yd2FyZFJlZiIsIk1hcmtkb3duIiwiTWFya2Rvd25QcmV2aWV3Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBd0VBLFNBQVNBLGdCQUFULEdBQThEO0FBQUEsTUFBcENDLElBQW9DLHVFQUFKLEVBQUk7QUFDNURDLEVBQUFBLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZRixJQUFaLEVBQWtCRyxPQUFsQixDQUEwQixVQUFDQyxPQUFELEVBQWE7QUFDckNKLElBQUFBLElBQUksQ0FBQ0ksT0FBRCxDQUFKLEdBQWdCLEtBQWhCO0FBQ0QsR0FGRDtBQUdBLFNBQU9KLElBQVA7QUFDRDs7QUFFRCxJQUFNSyxnQkFBZ0IsR0FBRyxTQUFuQkEsZ0JBQW1CLENBQ3ZCQyxLQUR1QixFQUV2QkMsR0FGdUIsRUFHcEI7QUFBQSxhQXFCQ0QsS0FBSyxJQUFJLEVBckJWO0FBQUEsNEJBRURFLFNBRkM7QUFBQSxNQUVEQSxTQUZDLCtCQUVXLGFBRlg7QUFBQSxNQUdEQyxTQUhDLFFBR0RBLFNBSEM7QUFBQSxNQUlNQyxVQUpOLFFBSURDLEtBSkM7QUFBQSwyQkFLREMsUUFMQztBQUFBLE1BS0RBLFFBTEMsOEJBS1UsNEJBTFY7QUFBQSx5QkFNREMsTUFOQztBQUFBLE1BTURBLE1BTkMsNEJBTVEsR0FOUjtBQUFBLCtCQU9EQyxZQVBDO0FBQUEsTUFPREEsWUFQQyxrQ0FPYyxJQVBkO0FBQUEsa0NBUURDLGVBUkM7QUFBQSxNQVFEQSxlQVJDLHFDQVFpQixJQVJqQjtBQUFBLGtDQVNEQyxlQVRDO0FBQUEsTUFTREEsZUFUQyxxQ0FTaUIsSUFUakI7QUFBQSwwQkFVREMsT0FWQztBQUFBLE1BVVFDLFdBVlIsNkJBVXNCLE1BVnRCO0FBQUEsNkJBV0RDLFVBWEM7QUFBQSxNQVdEQSxVQVhDLGdDQVdZLEtBWFo7QUFBQSxpQ0FZREMsY0FaQztBQUFBLE1BWURBLGNBWkMsb0NBWWdCLEVBWmhCO0FBQUEsTUFhREMsYUFiQyxRQWFEQSxhQWJDO0FBQUEsNEJBY0RDLFNBZEM7QUFBQSxNQWNEQSxTQWRDLCtCQWNXLElBZFg7QUFBQSw0QkFlREMsU0FmQztBQUFBLE1BZURBLFNBZkMsK0JBZVcsR0FmWDtBQUFBLE1BZ0JEQyxTQWhCQyxRQWdCREEsU0FoQkM7QUFBQSwwQkFpQkRDLE9BakJDO0FBQUEsTUFpQkRBLE9BakJDLDZCQWlCUyxDQWpCVDtBQUFBLE1Ba0JEQyxRQWxCQyxRQWtCREEsUUFsQkM7QUFBQSxNQW1CREMsV0FuQkMsUUFtQkRBLFdBbkJDO0FBQUEsTUFvQkVDLEtBcEJGOztBQUFBLG9CQXNCcUIsdUJBQVdDLGdCQUFYLEVBQW9CO0FBQzFDQyxJQUFBQSxRQUFRLEVBQUVwQixVQURnQztBQUUxQ08sSUFBQUEsT0FBTyxFQUFFQyxXQUZpQztBQUcxQ0wsSUFBQUEsTUFBTSxFQUFOQSxNQUgwQztBQUkxQ0csSUFBQUEsZUFBZSxFQUFmQSxlQUowQztBQUsxQ1MsSUFBQUEsT0FBTyxFQUFQQSxPQUwwQztBQU0xQ00sSUFBQUEsU0FBUyxFQUFFLENBTitCO0FBTzFDQyxJQUFBQSxnQkFBZ0IsRUFBRSxDQVB3QjtBQVExQ3BCLElBQUFBLFFBQVEsRUFBUkEsUUFSMEM7QUFTMUNPLElBQUFBLFVBQVUsRUFBVkEsVUFUMEM7QUFVMUNPLElBQUFBLFFBQVEsRUFBUkEsUUFWMEM7QUFXMUNPLElBQUFBLFFBQVEsRUFBRTtBQVhnQyxHQUFwQixDQXRCckI7QUFBQTtBQUFBLE1Bc0JFQyxLQXRCRjtBQUFBLE1Bc0JTQyxRQXRCVDs7QUFtQ0gsTUFBTUMsU0FBUyxHQUFHLG1CQUF1QixJQUF2QixDQUFsQjtBQUNBLE1BQU1DLFVBQVUsR0FBRyxtQkFBMkIsSUFBM0IsQ0FBbkI7QUFDQSxNQUFNQyxlQUFlLEdBQUcsbUJBQU94QixZQUFQLENBQXhCO0FBRUEsa0NBQW9CUCxHQUFwQixFQUF5QjtBQUFBLDJDQUFZMkIsS0FBWjtBQUFBLEdBQXpCO0FBQ0Esc0JBQVE7QUFBQSxXQUFPSSxlQUFlLENBQUNDLE9BQWhCLEdBQTBCekIsWUFBakM7QUFBQSxHQUFSLEVBQXdELENBQUNBLFlBQUQsQ0FBeEQ7QUFDQSx3QkFBVSxZQUFNO0FBQ2QsUUFBTTBCLFNBQXVCLEdBQUcsRUFBaEM7O0FBQ0EsUUFBSUosU0FBUyxDQUFDRyxPQUFkLEVBQXVCO0FBQ3JCQyxNQUFBQSxTQUFTLENBQUNKLFNBQVYsR0FBc0JBLFNBQVMsQ0FBQ0csT0FBVixJQUFxQkUsU0FBM0M7QUFDRDs7QUFDREQsSUFBQUEsU0FBUyxDQUFDVixRQUFWLEdBQXFCcEIsVUFBVSxJQUFJLEVBQW5DO0FBQ0E4QixJQUFBQSxTQUFTLENBQUNQLFFBQVYsR0FBcUIsRUFBckI7O0FBQ0EsUUFBSUUsUUFBSixFQUFjO0FBQ1pBLE1BQUFBLFFBQVEsNkRBQU1ELEtBQU4sR0FBZ0JNLFNBQWhCLEVBQVI7QUFDRCxLQVRhLENBVWQ7O0FBQ0QsR0FYRCxFQVdHLEVBWEg7QUFhQSxNQUFNRSxHQUFHLEdBQUcsQ0FDVmpDLFNBRFUsRUFFVkQsU0FGVSxFQUdWMEIsS0FBSyxDQUFDakIsT0FBTixhQUFtQlQsU0FBbkIsbUJBQXFDMEIsS0FBSyxDQUFDakIsT0FBM0MsSUFBdUQsSUFIN0MsRUFJVmlCLEtBQUssQ0FBQ2YsVUFBTixhQUFzQlgsU0FBdEIsbUJBQStDLElBSnJDLEVBTVRtQyxNQU5TLENBTUZDLE9BTkUsRUFPVEMsSUFQUyxDQU9KLEdBUEksRUFRVEMsSUFSUyxFQUFaO0FBVUEsc0JBQVE7QUFBQSxXQUFNcEMsVUFBVSxLQUFLd0IsS0FBSyxDQUFDSixRQUFyQixJQUFpQ0ssUUFBUSxDQUFDO0FBQUVMLE1BQUFBLFFBQVEsRUFBRXBCO0FBQVosS0FBRCxDQUEvQztBQUFBLEdBQVIsRUFBbUYsQ0FBQ0EsVUFBRCxDQUFuRjtBQUNBLHNCQUFRO0FBQUEsV0FBTVEsV0FBVyxLQUFLZ0IsS0FBSyxDQUFDakIsT0FBdEIsSUFBaUNrQixRQUFRLENBQUM7QUFBRWxCLE1BQUFBLE9BQU8sRUFBRUM7QUFBWCxLQUFELENBQS9DO0FBQUEsR0FBUixFQUFtRixDQUFDQSxXQUFELENBQW5GO0FBQ0Esc0JBQVE7QUFBQSxXQUFNTCxNQUFNLEtBQUtxQixLQUFLLENBQUNyQixNQUFqQixJQUEyQnNCLFFBQVEsQ0FBQztBQUFFdEIsTUFBQUEsTUFBTSxFQUFFQTtBQUFWLEtBQUQsQ0FBekM7QUFBQSxHQUFSLEVBQXVFLENBQUNBLE1BQUQsQ0FBdkU7QUFDQSxzQkFBUTtBQUFBLFdBQU1ZLE9BQU8sS0FBS1MsS0FBSyxDQUFDVCxPQUFsQixJQUE2QlUsUUFBUSxDQUFDO0FBQUVWLE1BQUFBLE9BQU8sRUFBUEE7QUFBRixLQUFELENBQTNDO0FBQUEsR0FBUixFQUFrRSxDQUFDQSxPQUFELENBQWxFO0FBQ0Esc0JBQVE7QUFBQSxXQUFNVCxlQUFlLEtBQUtrQixLQUFLLENBQUNsQixlQUExQixJQUE2Q21CLFFBQVEsQ0FBQztBQUFFbkIsTUFBQUEsZUFBZSxFQUFmQTtBQUFGLEtBQUQsQ0FBM0Q7QUFBQSxHQUFSLEVBQTBGLENBQUNBLGVBQUQsQ0FBMUY7QUFDQSxzQkFBUTtBQUFBLFdBQU1RLFNBQVMsS0FBS1UsS0FBSyxDQUFDVixTQUFwQixJQUFpQ1csUUFBUSxDQUFDO0FBQUVYLE1BQUFBLFNBQVMsRUFBRUE7QUFBYixLQUFELENBQS9DO0FBQUEsR0FBUixFQUFtRixDQUFDQSxTQUFELENBQW5GO0FBQ0Esc0JBQVE7QUFBQSxXQUFNTCxVQUFVLEtBQUtlLEtBQUssQ0FBQ2YsVUFBckIsSUFBbUNnQixRQUFRLENBQUM7QUFBRWhCLE1BQUFBLFVBQVUsRUFBRUE7QUFBZCxLQUFELENBQWpEO0FBQUEsR0FBUixFQUF1RixDQUFDQSxVQUFELENBQXZGO0FBRUEsTUFBTTRCLGNBQWMsR0FBRyxvQkFBdkI7QUFDQSxNQUFNQyxNQUFNLEdBQUcsb0JBQWY7QUFFQSxzQkFBUSxZQUFNO0FBQ1pELElBQUFBLGNBQWMsQ0FBQ1IsT0FBZixHQUF5QkwsS0FBSyxDQUFDZSxZQUEvQjs7QUFDQSxRQUFJZixLQUFLLENBQUNlLFlBQVYsRUFBd0I7QUFDdEJmLE1BQUFBLEtBQUssQ0FBQ2UsWUFBTixDQUFtQkMsZ0JBQW5CLENBQW9DLFdBQXBDLEVBQWlELFlBQU07QUFDckRGLFFBQUFBLE1BQU0sQ0FBQ1QsT0FBUCxHQUFpQixNQUFqQjtBQUNELE9BRkQ7QUFHQUwsTUFBQUEsS0FBSyxDQUFDZSxZQUFOLENBQW1CQyxnQkFBbkIsQ0FBb0MsWUFBcEMsRUFBa0QsWUFBTTtBQUN0REYsUUFBQUEsTUFBTSxDQUFDVCxPQUFQLEdBQWlCLFNBQWpCO0FBQ0QsT0FGRDtBQUdEO0FBQ0YsR0FWRCxFQVVHLENBQUNMLEtBQUssQ0FBQ2UsWUFBUCxDQVZIOztBQVlBLE1BQU1FLFlBQVksR0FBRyxTQUFmQSxZQUFlLENBQUNDLENBQUQsRUFBc0M7QUFDekQsUUFBSSxDQUFDZCxlQUFlLENBQUNDLE9BQXJCLEVBQThCO0FBQzlCLFFBQU1jLFdBQVcsR0FBR04sY0FBYyxDQUFDUixPQUFuQztBQUNBLFFBQU1lLFVBQVUsR0FBR2pCLFVBQVUsQ0FBQ0UsT0FBWCxHQUFxQkYsVUFBVSxDQUFDRSxPQUFYLENBQW1CZ0IsR0FBbkIsQ0FBdUJoQixPQUE1QyxHQUFzREUsU0FBekU7O0FBQ0EsUUFBSVksV0FBVyxJQUFJQyxVQUFuQixFQUErQjtBQUM3QixVQUFNRSxLQUFLLEdBQ1QsQ0FBQ0gsV0FBVyxDQUFDSSxZQUFaLEdBQTJCSixXQUFXLENBQUNLLFlBQXhDLEtBQXlESixVQUFVLENBQUNHLFlBQVgsR0FBMEJILFVBQVUsQ0FBQ0ksWUFBOUYsQ0FERjs7QUFFQSxVQUFJTixDQUFDLENBQUNPLE1BQUYsS0FBYU4sV0FBYixJQUE0QkwsTUFBTSxDQUFDVCxPQUFQLEtBQW1CLE1BQW5ELEVBQTJEO0FBQ3pEZSxRQUFBQSxVQUFVLENBQUN2QixTQUFYLEdBQXVCc0IsV0FBVyxDQUFDdEIsU0FBWixHQUF3QnlCLEtBQS9DO0FBQ0Q7O0FBQ0QsVUFBSUosQ0FBQyxDQUFDTyxNQUFGLEtBQWFMLFVBQWIsSUFBMkJOLE1BQU0sQ0FBQ1QsT0FBUCxLQUFtQixTQUFsRCxFQUE2RDtBQUMzRGMsUUFBQUEsV0FBVyxDQUFDdEIsU0FBWixHQUF3QnVCLFVBQVUsQ0FBQ3ZCLFNBQVgsR0FBdUJ5QixLQUEvQztBQUNEOztBQUNELFVBQUl6QixTQUFTLEdBQUcsQ0FBaEI7O0FBQ0EsVUFBSWlCLE1BQU0sQ0FBQ1QsT0FBUCxLQUFtQixNQUF2QixFQUErQjtBQUM3QlIsUUFBQUEsU0FBUyxHQUFHc0IsV0FBVyxDQUFDdEIsU0FBWixJQUF5QixDQUFyQztBQUNELE9BRkQsTUFFTyxJQUFJaUIsTUFBTSxDQUFDVCxPQUFQLEtBQW1CLFNBQXZCLEVBQWtDO0FBQ3ZDUixRQUFBQSxTQUFTLEdBQUd1QixVQUFVLENBQUN2QixTQUFYLElBQXdCLENBQXBDO0FBQ0Q7O0FBQ0RJLE1BQUFBLFFBQVEsQ0FBQztBQUFFSixRQUFBQSxTQUFTLEVBQVRBO0FBQUYsT0FBRCxDQUFSO0FBQ0Q7QUFDRixHQXJCRDs7QUF1QkEsc0JBQ0UsNkJBQUMsc0JBQUQsQ0FBZSxRQUFmO0FBQXdCLElBQUEsS0FBSyw4REFBT0csS0FBUDtBQUFjQyxNQUFBQSxRQUFRLEVBQVJBO0FBQWQ7QUFBN0Isa0JBQ0U7QUFDRSxJQUFBLEdBQUcsRUFBRUMsU0FEUDtBQUVFLElBQUEsU0FBUyxFQUFFTSxHQUZiO0FBR0UsSUFBQSxPQUFPLEVBQUUsbUJBQU07QUFDYlAsTUFBQUEsUUFBUSxDQUFDO0FBQUVGLFFBQUFBLFFBQVEsa0NBQU9sQyxnQkFBZ0IsQ0FBQ21DLEtBQUssQ0FBQ0QsUUFBUCxDQUF2QjtBQUFWLE9BQUQsQ0FBUjtBQUNELEtBTEg7QUFNRSxJQUFBLEtBQUssRUFBRTtBQUFFcEIsTUFBQUEsTUFBTSxFQUFFcUIsS0FBSyxDQUFDZixVQUFOLEdBQW1CLE1BQW5CLEdBQTRCUSxXQUFXLEdBQUdpQyxNQUFNLENBQUMxQixLQUFLLENBQUNyQixNQUFQLENBQU4sR0FBdUIsRUFBMUIsR0FBK0JxQixLQUFLLENBQUNyQjtBQUF0RjtBQU5ULEtBT01lLEtBUE4sR0FTRyxDQUFDRCxXQUFELGlCQUFnQiw2QkFBQyxnQkFBRDtBQUFTLElBQUEsU0FBUyxFQUFFbkI7QUFBcEIsSUFUbkIsZUFVRTtBQUNFLElBQUEsU0FBUyxZQUFLQSxTQUFMLGFBRFg7QUFFRSxJQUFBLEtBQUssRUFBRTtBQUFFSyxNQUFBQSxNQUFNLEVBQUVxQixLQUFLLENBQUNmLFVBQU4sR0FBbUIsbUJBQW5CLEdBQXlDeUMsTUFBTSxDQUFDMUIsS0FBSyxDQUFDckIsTUFBUCxDQUFOLEdBQXVCO0FBQTFFO0FBRlQsS0FJRyxjQUFjZ0QsSUFBZCxDQUFtQjNCLEtBQUssQ0FBQ2pCLE9BQU4sSUFBaUIsRUFBcEMsa0JBQ0MsNkJBQUMsaUJBQUQ7QUFDRSxJQUFBLFNBQVMsWUFBS1QsU0FBTCxXQURYO0FBRUUsSUFBQSxTQUFTLEVBQUVBLFNBRmI7QUFHRSxJQUFBLFNBQVMsRUFBRWdCO0FBSGIsS0FJTUgsYUFKTjtBQUtFLElBQUEsUUFBUSxFQUFFOEI7QUFMWixLQUxKLEVBYUcsaUJBQWlCVSxJQUFqQixDQUFzQjNCLEtBQUssQ0FBQ2pCLE9BQU4sSUFBaUIsRUFBdkMsa0JBQ0MsNkJBQUMsNkJBQUQsNkJBQ09HLGNBRFA7QUFFRSxJQUFBLFFBQVEsRUFBRStCLFlBRlo7QUFHRSxJQUFBLEdBQUcsRUFBRWQsVUFIUDtBQUlFLElBQUEsTUFBTSxFQUFFSCxLQUFLLENBQUNKLFFBQU4sSUFBa0IsRUFKNUI7QUFLRSxJQUFBLFNBQVMsWUFBS3RCLFNBQUw7QUFMWCxLQWRKLENBVkYsRUFpQ0dPLGVBQWUsSUFBSSxDQUFDbUIsS0FBSyxDQUFDZixVQUExQixpQkFDQyw2QkFBQyxnQkFBRDtBQUNFLElBQUEsU0FBUyxFQUFFWCxTQURiO0FBRUUsSUFBQSxNQUFNLEVBQUUwQixLQUFLLENBQUNyQixNQUZoQjtBQUdFLElBQUEsU0FBUyxFQUFFUyxTQUhiO0FBSUUsSUFBQSxTQUFTLEVBQUVDLFNBSmI7QUFLRSxJQUFBLFFBQVEsRUFBRSxrQkFBQ3VDLFNBQUQsRUFBZTtBQUN2QjNCLE1BQUFBLFFBQVEsQ0FBQztBQUFFdEIsUUFBQUEsTUFBTSxFQUFFaUQ7QUFBVixPQUFELENBQVI7QUFDRDtBQVBILElBbENKLENBREYsQ0FERjtBQWlERCxDQWxLRDs7QUFvS0EsSUFBTUMsUUFBUSxnQkFBR0MsZUFBTUMsVUFBTixDQUE4QzVELGdCQUE5QyxDQUFqQjs7QUFNQzBELFFBQUQsQ0FBdUJHLFFBQXZCLEdBQWtDQyw2QkFBbEM7ZUFFZUosUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyB1c2VFZmZlY3QsIHVzZVJlZHVjZXIsIHVzZU1lbW8sIHVzZVJlZiwgdXNlSW1wZXJhdGl2ZUhhbmRsZSB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBNYXJrZG93blByZXZpZXcsIHsgTWFya2Rvd25QcmV2aWV3UHJvcHMsIE1hcmtkb3duUHJldmlld1JlZiB9IGZyb20gJ0B1aXcvcmVhY3QtbWFya2Rvd24tcHJldmlldyc7XG5pbXBvcnQgeyBJUHJvcHMgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCBUZXh0QXJlYSwgeyBJVGV4dEFyZWFQcm9wcyB9IGZyb20gJy4vY29tcG9uZW50cy9UZXh0QXJlYSc7XG5pbXBvcnQgVG9vbGJhciBmcm9tICcuL2NvbXBvbmVudHMvVG9vbGJhcic7XG5pbXBvcnQgRHJhZ0JhciBmcm9tICcuL2NvbXBvbmVudHMvRHJhZ0Jhcic7XG5pbXBvcnQgeyBnZXRDb21tYW5kcywgSUNvbW1hbmQgfSBmcm9tICcuL2NvbW1hbmRzJztcbmltcG9ydCB7IHJlZHVjZXIsIEVkaXRvckNvbnRleHQsIENvbnRleHRTdG9yZSwgUHJldmlld1R5cGUgfSBmcm9tICcuL0NvbnRleHQnO1xuaW1wb3J0ICcuL2luZGV4Lmxlc3MnO1xuXG5leHBvcnQgaW50ZXJmYWNlIE1ERWRpdG9yUHJvcHMgZXh0ZW5kcyBPbWl0PFJlYWN0LkhUTUxBdHRyaWJ1dGVzPEhUTUxEaXZFbGVtZW50PiwgJ29uQ2hhbmdlJz4sIElQcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgTWFya2Rvd24gdmFsdWUuXG4gICAqL1xuICB2YWx1ZT86IHN0cmluZztcbiAgLyoqXG4gICAqIEV2ZW50IGhhbmRsZXIgZm9yIHRoZSBgb25DaGFuZ2VgIGV2ZW50LlxuICAgKi9cbiAgb25DaGFuZ2U/OiAodmFsdWU/OiBzdHJpbmcpID0+IHZvaWQ7XG4gIC8qKlxuICAgKiBDYW4gYmUgdXNlZCB0byBtYWtlIGBNYXJrZG93biBFZGl0b3JgIGZvY3VzIGl0c2VsZiBvbiBpbml0aWFsaXphdGlvbi4gRGVmYXVsdHMgdG8gb24uXG4gICAqIGl0IHdpbGwgYmUgc2V0IHRvIHRydWUgd2hlbiBlaXRoZXIgdGhlIHNvdXJjZSBgdGV4dGFyZWFgIGlzIGZvY3VzZWQsXG4gICAqIG9yIGl0IGhhcyBhbiBgYXV0b2ZvY3VzYCBhdHRyaWJ1dGUgYW5kIG5vIG90aGVyIGVsZW1lbnQgaXMgZm9jdXNlZC5cbiAgICovXG4gIGF1dG9Gb2N1cz86IElUZXh0QXJlYVByb3BzWydhdXRvRm9jdXMnXTtcbiAgLyoqXG4gICAqIFRoZSBoZWlnaHQgb2YgdGhlIGVkaXRvci5cbiAgICovXG4gIGhlaWdodD86IG51bWJlcjtcbiAgLyoqXG4gICAqIFNob3cgZHJhZyBhbmQgZHJvcCB0b29sLiBTZXQgdGhlIGhlaWdodCBvZiB0aGUgZWRpdG9yLlxuICAgKi9cbiAgdmlzaWFibGVEcmFnYmFyPzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFNob3cgbWFya2Rvd24gcHJldmlldy5cbiAgICovXG4gIHByZXZpZXc/OiBQcmV2aWV3VHlwZTtcbiAgLyoqXG4gICAqIEZ1bGwgc2NyZWVuIGRpc3BsYXkgZWRpdG9yLlxuICAgKi9cbiAgZnVsbHNjcmVlbj86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBNYXhpbXVtIGRyYWcgaGVpZ2h0LiBgdmlzaWFibGVEcmFnYmFyPXRydWVgXG4gICAqL1xuICBtYXhIZWlnaHQ/OiBudW1iZXI7XG4gIC8qKlxuICAgKiBNaW5pbXVtIGRyYWcgaGVpZ2h0LiBgdmlzaWFibGVEcmFnYmFyPXRydWVgXG4gICAqL1xuICBtaW5IZWlnaHQ/OiBudW1iZXI7XG4gIC8qKlxuICAgKiBUaGlzIGlzIHJlc2V0IFtyZWFjdC1tYXJrZG93bl0oaHR0cHM6Ly9naXRodWIuY29tL3JleHhhcnMvcmVhY3QtbWFya2Rvd24pIHNldHRpbmdzLlxuICAgKi9cbiAgcHJldmlld09wdGlvbnM/OiBPbWl0PE1hcmtkb3duUHJldmlld1Byb3BzLCAnc291cmNlJz47XG4gIC8qKlxuICAgKiBTZXQgdGhlIGB0ZXh0YXJlYWAgcmVsYXRlZCBwcm9wcy5cbiAgICovXG4gIHRleHRhcmVhUHJvcHM/OiBJVGV4dEFyZWFQcm9wcztcbiAgLyoqXG4gICAqIERpc2FibGUgZWRpdGluZyBhcmVhIGNvZGUgaGlnaGxpZ2h0aW5nLiBUaGUgdmFsdWUgaXMgYGZhbHNlYCwgd2hpY2ggaW5jcmVhc2VzIHRoZSBlZGl0aW5nIHNwZWVkLlxuICAgKiBAZGVmYXVsdCB0cnVlXG4gICAqL1xuICBoaWdobGlnaHRFbmFibGU/OiBib29sZWFuO1xuICAvKipcbiAgICogVGhlIG51bWJlciBvZiBjaGFyYWN0ZXJzIHRvIGluc2VydCB3aGVuIHByZXNzaW5nIHRhYiBrZXkuXG4gICAqIERlZmF1bHQgYDJgIHNwYWNlcy5cbiAgICovXG4gIHRhYlNpemU/OiBudW1iZXI7XG4gIC8qKlxuICAgKiBZb3UgY2FuIGNyZWF0ZSB5b3VyIG93biBjb21tYW5kcyBvciByZXVzZSBleGlzdGluZyBjb21tYW5kcy5cbiAgICovXG4gIGNvbW1hbmRzPzogSUNvbW1hbmRbXTtcbiAgLyoqXG4gICAqIEhpZGUgdGhlIHRvb2wgYmFyXG4gICAqL1xuICBoaWRlVG9vbGJhcj86IGJvb2xlYW47XG4gIC8qKiBXaGV0aGVyIHRvIGVuYWJsZSBzY3JvbGxpbmcgKi9cbiAgZW5hYmxlU2Nyb2xsPzogYm9vbGVhbjtcbn1cblxuZnVuY3Rpb24gc2V0R3JvdXBQb3BGYWxzZShkYXRhOiBSZWNvcmQ8c3RyaW5nLCBib29sZWFuPiA9IHt9KSB7XG4gIE9iamVjdC5rZXlzKGRhdGEpLmZvckVhY2goKGtleW5hbWUpID0+IHtcbiAgICBkYXRhW2tleW5hbWVdID0gZmFsc2U7XG4gIH0pO1xuICByZXR1cm4gZGF0YTtcbn1cblxuY29uc3QgSW50ZXJuYWxNREVkaXRvciA9IChcbiAgcHJvcHM6IE1ERWRpdG9yUHJvcHMsXG4gIHJlZj86ICgoaW5zdGFuY2U6IENvbnRleHRTdG9yZSkgPT4gdm9pZCkgfCBSZWFjdC5SZWZPYmplY3Q8Q29udGV4dFN0b3JlPiB8IG51bGwsXG4pID0+IHtcbiAgY29uc3Qge1xuICAgIHByZWZpeENscyA9ICd3LW1kLWVkaXRvcicsXG4gICAgY2xhc3NOYW1lLFxuICAgIHZhbHVlOiBwcm9wc1ZhbHVlLFxuICAgIGNvbW1hbmRzID0gZ2V0Q29tbWFuZHMoKSxcbiAgICBoZWlnaHQgPSAyMDAsXG4gICAgZW5hYmxlU2Nyb2xsID0gdHJ1ZSxcbiAgICB2aXNpYWJsZURyYWdiYXIgPSB0cnVlLFxuICAgIGhpZ2hsaWdodEVuYWJsZSA9IHRydWUsXG4gICAgcHJldmlldzogcHJldmlld1R5cGUgPSAnbGl2ZScsXG4gICAgZnVsbHNjcmVlbiA9IGZhbHNlLFxuICAgIHByZXZpZXdPcHRpb25zID0ge30sXG4gICAgdGV4dGFyZWFQcm9wcyxcbiAgICBtYXhIZWlnaHQgPSAxMjAwLFxuICAgIG1pbkhlaWdodCA9IDEwMCxcbiAgICBhdXRvRm9jdXMsXG4gICAgdGFiU2l6ZSA9IDIsXG4gICAgb25DaGFuZ2UsXG4gICAgaGlkZVRvb2xiYXIsXG4gICAgLi4ub3RoZXJcbiAgfSA9IHByb3BzIHx8IHt9O1xuICBsZXQgW3N0YXRlLCBkaXNwYXRjaF0gPSB1c2VSZWR1Y2VyKHJlZHVjZXIsIHtcbiAgICBtYXJrZG93bjogcHJvcHNWYWx1ZSxcbiAgICBwcmV2aWV3OiBwcmV2aWV3VHlwZSxcbiAgICBoZWlnaHQsXG4gICAgaGlnaGxpZ2h0RW5hYmxlLFxuICAgIHRhYlNpemUsXG4gICAgc2Nyb2xsVG9wOiAwLFxuICAgIHNjcm9sbFRvcFByZXZpZXc6IDAsXG4gICAgY29tbWFuZHMsXG4gICAgZnVsbHNjcmVlbixcbiAgICBvbkNoYW5nZSxcbiAgICBiYXJQb3B1cDoge30sXG4gIH0pO1xuICBjb25zdCBjb250YWluZXIgPSB1c2VSZWY8SFRNTERpdkVsZW1lbnQ+KG51bGwpO1xuICBjb25zdCBwcmV2aWV3UmVmID0gdXNlUmVmPE1hcmtkb3duUHJldmlld1JlZj4obnVsbCk7XG4gIGNvbnN0IGVuYWJsZVNjcm9sbFJlZiA9IHVzZVJlZihlbmFibGVTY3JvbGwpO1xuXG4gIHVzZUltcGVyYXRpdmVIYW5kbGUocmVmLCAoKSA9PiAoeyAuLi5zdGF0ZSB9KSk7XG4gIHVzZU1lbW8oKCkgPT4gKGVuYWJsZVNjcm9sbFJlZi5jdXJyZW50ID0gZW5hYmxlU2Nyb2xsKSwgW2VuYWJsZVNjcm9sbF0pO1xuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGNvbnN0IHN0YXRlSW5pdDogQ29udGV4dFN0b3JlID0ge307XG4gICAgaWYgKGNvbnRhaW5lci5jdXJyZW50KSB7XG4gICAgICBzdGF0ZUluaXQuY29udGFpbmVyID0gY29udGFpbmVyLmN1cnJlbnQgfHwgdW5kZWZpbmVkO1xuICAgIH1cbiAgICBzdGF0ZUluaXQubWFya2Rvd24gPSBwcm9wc1ZhbHVlIHx8ICcnO1xuICAgIHN0YXRlSW5pdC5iYXJQb3B1cCA9IHt9O1xuICAgIGlmIChkaXNwYXRjaCkge1xuICAgICAgZGlzcGF0Y2goeyAuLi5zdGF0ZSwgLi4uc3RhdGVJbml0IH0pO1xuICAgIH1cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3QtaG9va3MvZXhoYXVzdGl2ZS1kZXBzXG4gIH0sIFtdKTtcblxuICBjb25zdCBjbHMgPSBbXG4gICAgY2xhc3NOYW1lLFxuICAgIHByZWZpeENscyxcbiAgICBzdGF0ZS5wcmV2aWV3ID8gYCR7cHJlZml4Q2xzfS1zaG93LSR7c3RhdGUucHJldmlld31gIDogbnVsbCxcbiAgICBzdGF0ZS5mdWxsc2NyZWVuID8gYCR7cHJlZml4Q2xzfS1mdWxsc2NyZWVuYCA6IG51bGwsXG4gIF1cbiAgICAuZmlsdGVyKEJvb2xlYW4pXG4gICAgLmpvaW4oJyAnKVxuICAgIC50cmltKCk7XG5cbiAgdXNlTWVtbygoKSA9PiBwcm9wc1ZhbHVlICE9PSBzdGF0ZS5tYXJrZG93biAmJiBkaXNwYXRjaCh7IG1hcmtkb3duOiBwcm9wc1ZhbHVlIH0pLCBbcHJvcHNWYWx1ZV0pO1xuICB1c2VNZW1vKCgpID0+IHByZXZpZXdUeXBlICE9PSBzdGF0ZS5wcmV2aWV3ICYmIGRpc3BhdGNoKHsgcHJldmlldzogcHJldmlld1R5cGUgfSksIFtwcmV2aWV3VHlwZV0pO1xuICB1c2VNZW1vKCgpID0+IGhlaWdodCAhPT0gc3RhdGUuaGVpZ2h0ICYmIGRpc3BhdGNoKHsgaGVpZ2h0OiBoZWlnaHQgfSksIFtoZWlnaHRdKTtcbiAgdXNlTWVtbygoKSA9PiB0YWJTaXplICE9PSBzdGF0ZS50YWJTaXplICYmIGRpc3BhdGNoKHsgdGFiU2l6ZSB9KSwgW3RhYlNpemVdKTtcbiAgdXNlTWVtbygoKSA9PiBoaWdobGlnaHRFbmFibGUgIT09IHN0YXRlLmhpZ2hsaWdodEVuYWJsZSAmJiBkaXNwYXRjaCh7IGhpZ2hsaWdodEVuYWJsZSB9KSwgW2hpZ2hsaWdodEVuYWJsZV0pO1xuICB1c2VNZW1vKCgpID0+IGF1dG9Gb2N1cyAhPT0gc3RhdGUuYXV0b0ZvY3VzICYmIGRpc3BhdGNoKHsgYXV0b0ZvY3VzOiBhdXRvRm9jdXMgfSksIFthdXRvRm9jdXNdKTtcbiAgdXNlTWVtbygoKSA9PiBmdWxsc2NyZWVuICE9PSBzdGF0ZS5mdWxsc2NyZWVuICYmIGRpc3BhdGNoKHsgZnVsbHNjcmVlbjogZnVsbHNjcmVlbiB9KSwgW2Z1bGxzY3JlZW5dKTtcblxuICBjb25zdCB0ZXh0YXJlYURvbVJlZiA9IHVzZVJlZjxIVE1MRGl2RWxlbWVudD4oKTtcbiAgY29uc3QgYWN0aXZlID0gdXNlUmVmPCd0ZXh0JyB8ICdwcmV2aWV3Jz4oKTtcblxuICB1c2VNZW1vKCgpID0+IHtcbiAgICB0ZXh0YXJlYURvbVJlZi5jdXJyZW50ID0gc3RhdGUudGV4dGFyZWFXYXJwO1xuICAgIGlmIChzdGF0ZS50ZXh0YXJlYVdhcnApIHtcbiAgICAgIHN0YXRlLnRleHRhcmVhV2FycC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW92ZXInLCAoKSA9PiB7XG4gICAgICAgIGFjdGl2ZS5jdXJyZW50ID0gJ3RleHQnO1xuICAgICAgfSk7XG4gICAgICBzdGF0ZS50ZXh0YXJlYVdhcnAuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsICgpID0+IHtcbiAgICAgICAgYWN0aXZlLmN1cnJlbnQgPSAncHJldmlldyc7XG4gICAgICB9KTtcbiAgICB9XG4gIH0sIFtzdGF0ZS50ZXh0YXJlYVdhcnBdKTtcblxuICBjb25zdCBoYW5kbGVTY3JvbGwgPSAoZTogUmVhY3QuVUlFdmVudDxIVE1MRGl2RWxlbWVudD4pID0+IHtcbiAgICBpZiAoIWVuYWJsZVNjcm9sbFJlZi5jdXJyZW50KSByZXR1cm47XG4gICAgY29uc3QgdGV4dGFyZWFEb20gPSB0ZXh0YXJlYURvbVJlZi5jdXJyZW50O1xuICAgIGNvbnN0IHByZXZpZXdEb20gPSBwcmV2aWV3UmVmLmN1cnJlbnQgPyBwcmV2aWV3UmVmLmN1cnJlbnQubWRwLmN1cnJlbnQgOiB1bmRlZmluZWQ7XG4gICAgaWYgKHRleHRhcmVhRG9tICYmIHByZXZpZXdEb20pIHtcbiAgICAgIGNvbnN0IHNjYWxlID1cbiAgICAgICAgKHRleHRhcmVhRG9tLnNjcm9sbEhlaWdodCAtIHRleHRhcmVhRG9tLm9mZnNldEhlaWdodCkgLyAocHJldmlld0RvbS5zY3JvbGxIZWlnaHQgLSBwcmV2aWV3RG9tLm9mZnNldEhlaWdodCk7XG4gICAgICBpZiAoZS50YXJnZXQgPT09IHRleHRhcmVhRG9tICYmIGFjdGl2ZS5jdXJyZW50ID09PSAndGV4dCcpIHtcbiAgICAgICAgcHJldmlld0RvbS5zY3JvbGxUb3AgPSB0ZXh0YXJlYURvbS5zY3JvbGxUb3AgLyBzY2FsZTtcbiAgICAgIH1cbiAgICAgIGlmIChlLnRhcmdldCA9PT0gcHJldmlld0RvbSAmJiBhY3RpdmUuY3VycmVudCA9PT0gJ3ByZXZpZXcnKSB7XG4gICAgICAgIHRleHRhcmVhRG9tLnNjcm9sbFRvcCA9IHByZXZpZXdEb20uc2Nyb2xsVG9wICogc2NhbGU7XG4gICAgICB9XG4gICAgICBsZXQgc2Nyb2xsVG9wID0gMDtcbiAgICAgIGlmIChhY3RpdmUuY3VycmVudCA9PT0gJ3RleHQnKSB7XG4gICAgICAgIHNjcm9sbFRvcCA9IHRleHRhcmVhRG9tLnNjcm9sbFRvcCB8fCAwO1xuICAgICAgfSBlbHNlIGlmIChhY3RpdmUuY3VycmVudCA9PT0gJ3ByZXZpZXcnKSB7XG4gICAgICAgIHNjcm9sbFRvcCA9IHByZXZpZXdEb20uc2Nyb2xsVG9wIHx8IDA7XG4gICAgICB9XG4gICAgICBkaXNwYXRjaCh7IHNjcm9sbFRvcCB9KTtcbiAgICB9XG4gIH07XG5cbiAgcmV0dXJuIChcbiAgICA8RWRpdG9yQ29udGV4dC5Qcm92aWRlciB2YWx1ZT17eyAuLi5zdGF0ZSwgZGlzcGF0Y2ggfX0+XG4gICAgICA8ZGl2XG4gICAgICAgIHJlZj17Y29udGFpbmVyfVxuICAgICAgICBjbGFzc05hbWU9e2Nsc31cbiAgICAgICAgb25DbGljaz17KCkgPT4ge1xuICAgICAgICAgIGRpc3BhdGNoKHsgYmFyUG9wdXA6IHsgLi4uc2V0R3JvdXBQb3BGYWxzZShzdGF0ZS5iYXJQb3B1cCkgfSB9KTtcbiAgICAgICAgfX1cbiAgICAgICAgc3R5bGU9e3sgaGVpZ2h0OiBzdGF0ZS5mdWxsc2NyZWVuID8gJzEwMCUnIDogaGlkZVRvb2xiYXIgPyBOdW1iZXIoc3RhdGUuaGVpZ2h0KSAtIDI5IDogc3RhdGUuaGVpZ2h0IH19XG4gICAgICAgIHsuLi5vdGhlcn1cbiAgICAgID5cbiAgICAgICAgeyFoaWRlVG9vbGJhciAmJiA8VG9vbGJhciBwcmVmaXhDbHM9e3ByZWZpeENsc30gLz59XG4gICAgICAgIDxkaXZcbiAgICAgICAgICBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tY29udGVudGB9XG4gICAgICAgICAgc3R5bGU9e3sgaGVpZ2h0OiBzdGF0ZS5mdWxsc2NyZWVuID8gJ2NhbGMoMTAwJSAtIDI5cHgpJyA6IE51bWJlcihzdGF0ZS5oZWlnaHQpIC0gMjkgfX1cbiAgICAgICAgPlxuICAgICAgICAgIHsvKGVkaXR8bGl2ZSkvLnRlc3Qoc3RhdGUucHJldmlldyB8fCAnJykgJiYgKFxuICAgICAgICAgICAgPFRleHRBcmVhXG4gICAgICAgICAgICAgIGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS1pbnB1dGB9XG4gICAgICAgICAgICAgIHByZWZpeENscz17cHJlZml4Q2xzfVxuICAgICAgICAgICAgICBhdXRvRm9jdXM9e2F1dG9Gb2N1c31cbiAgICAgICAgICAgICAgey4uLnRleHRhcmVhUHJvcHN9XG4gICAgICAgICAgICAgIG9uU2Nyb2xsPXtoYW5kbGVTY3JvbGx9XG4gICAgICAgICAgICAvPlxuICAgICAgICAgICl9XG4gICAgICAgICAgey8obGl2ZXxwcmV2aWV3KS8udGVzdChzdGF0ZS5wcmV2aWV3IHx8ICcnKSAmJiAoXG4gICAgICAgICAgICA8TWFya2Rvd25QcmV2aWV3XG4gICAgICAgICAgICAgIHsuLi4ocHJldmlld09wdGlvbnMgYXMgdW5rbm93bil9XG4gICAgICAgICAgICAgIG9uU2Nyb2xsPXtoYW5kbGVTY3JvbGx9XG4gICAgICAgICAgICAgIHJlZj17cHJldmlld1JlZn1cbiAgICAgICAgICAgICAgc291cmNlPXtzdGF0ZS5tYXJrZG93biB8fCAnJ31cbiAgICAgICAgICAgICAgY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LXByZXZpZXdgfVxuICAgICAgICAgICAgLz5cbiAgICAgICAgICApfVxuICAgICAgICA8L2Rpdj5cbiAgICAgICAge3Zpc2lhYmxlRHJhZ2JhciAmJiAhc3RhdGUuZnVsbHNjcmVlbiAmJiAoXG4gICAgICAgICAgPERyYWdCYXJcbiAgICAgICAgICAgIHByZWZpeENscz17cHJlZml4Q2xzfVxuICAgICAgICAgICAgaGVpZ2h0PXtzdGF0ZS5oZWlnaHQgYXMgbnVtYmVyfVxuICAgICAgICAgICAgbWF4SGVpZ2h0PXttYXhIZWlnaHQhfVxuICAgICAgICAgICAgbWluSGVpZ2h0PXttaW5IZWlnaHQhfVxuICAgICAgICAgICAgb25DaGFuZ2U9eyhuZXdIZWlnaHQpID0+IHtcbiAgICAgICAgICAgICAgZGlzcGF0Y2goeyBoZWlnaHQ6IG5ld0hlaWdodCB9KTtcbiAgICAgICAgICAgIH19XG4gICAgICAgICAgLz5cbiAgICAgICAgKX1cbiAgICAgIDwvZGl2PlxuICAgIDwvRWRpdG9yQ29udGV4dC5Qcm92aWRlcj5cbiAgKTtcbn07XG5cbmNvbnN0IG1kRWRpdG9yID0gUmVhY3QuZm9yd2FyZFJlZjxDb250ZXh0U3RvcmUsIE1ERWRpdG9yUHJvcHM+KEludGVybmFsTURFZGl0b3IpO1xuXG50eXBlIE1ERWRpdG9yID0gdHlwZW9mIG1kRWRpdG9yICYge1xuICBNYXJrZG93bjogdHlwZW9mIE1hcmtkb3duUHJldmlldztcbn07XG5cbihtZEVkaXRvciBhcyBNREVkaXRvcikuTWFya2Rvd24gPSBNYXJrZG93blByZXZpZXc7XG5cbmV4cG9ydCBkZWZhdWx0IG1kRWRpdG9yIGFzIE1ERWRpdG9yO1xuIl19